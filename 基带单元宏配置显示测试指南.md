# 基带单元宏配置显示测试指南

## 功能说明

在基带单元的任务分组视图中，显示创建该任务时使用的宏配置信息。

## 已完成的修改

### 1. 数据库修改 ✅
- 已为 `sys_baseband_unit` 表添加 `macro_id` 字段
- 字段已存在，无需重复执行SQL脚本

### 2. 后端修改 ✅
- **实体类** (`SysBasebandUnit.java`)：已添加 `macroId` 和 `macroName` 字段
- **Mapper XML** (`SysBasebandUnitMapper.xml`)：
  - 查询语句已关联 `sys_baseband_macro` 表获取宏名称
  - 插入和更新语句已支持 `macro_id` 字段

### 3. 前端修改 ✅
- **创建单元时保存宏ID**：
  - 在 `submitForm()` 方法中，批量创建单元时会根据选择的宏任务为每个单元类型匹配对应的宏ID
  - 代码逻辑：
    ```javascript
    // 查找对应的宏ID
    let macroId = null
    if (form.value.macroTaskKey && selectedMacroTask.value) {
      const matchingMacro = selectedMacroTask.value.macros.find(macro => macro.unitType === unitType)
      if (matchingMacro) {
        macroId = matchingMacro.macroId
      }
    }
    
    const unitData = {
      // ... 其他字段
      macroId: macroId  // 添加宏ID
    }
    ```

- **任务视图显示宏信息**：
  - 在任务卡片中显示宏配置名称（去掉单元类型后缀）
  - 显示位置：任务头部下方，紫色渐变背景

## 测试步骤

### 前提条件
1. 确保后端服务正在运行
2. 确保已创建至少一个宏任务（包含多个单元类型）

### 测试流程

#### 步骤1：创建宏任务
1. 进入：**基带监控 > 宏管理**
2. 点击"新增"
3. 填写信息：
   - 宏名称：`测试卫星1`
   - 单元类型：勾选 `编码`、`调制`、`解调`、`译码`（全选）
   - 模式类型：选择 `KSA`
4. 点击"确定"
5. 为每个单元类型配置参数（可选）

#### 步骤2：使用宏创建基带单元
1. 进入：**基带监控 > 基带单元**
2. 点击"新增"
3. 填写信息：
   - 链路模式：选择 `返向中低速数传`
   - 单元类型：勾选 `编码`、`调制`、`解调`、`译码`（全选）
   - 模式类型：选择 `KSA`
   - 板卡资源：选择 `板1-FPGA0`
   - **应用宏配置**：选择 `测试卫星1` ⭐ 关键步骤
4. 点击"确定"

#### 步骤3：查看宏配置显示
1. 页面自动刷新后，查看任务分组视图
2. 找到刚创建的任务卡片
3. **验证点**：
   - ✅ 任务头部显示：`板1 - FPGA0` `返向中低速数传` `KSA`
   - ✅ 任务头部下方显示：`🪄 宏配置：测试卫星1`
   - ✅ 显示4个单元：编码、调制、解调、译码

### 预期效果

```
┌─────────────────────────────────────────────────────────┐
│ 🖥️ 板1 - FPGA0  [返向中低速数传] [KSA]     [删除任务] │
├─────────────────────────────────────────────────────────┤
│ 🪄 宏配置：测试卫星1                                    │  ⬅️ 这里显示宏名称
├─────────────────────────────────────────────────────────┤
│ ┃ [编码]    v1.0  [正常]     配置 修改 删除            │
│ ┃ [调制]    v1.0  [正常]     配置 修改 删除            │
│ ┃ [解调]    v1.0  [正常]     配置 修改 删除            │
│ ┃ [译码]    v1.0  [正常]     配置 修改 删除            │
└─────────────────────────────────────────────────────────┘
```

## 注意事项

### 1. 宏名称显示规则
- 显示的是**基础宏名称**，会自动去掉单元类型后缀
- 例如：
  - 数据库中存储：`测试卫星1(编码)`、`测试卫星1(调制)`、`测试卫星1(解调)`、`测试卫星1(译码)`
  - 任务中显示：`测试卫星1`

### 2. 宏配置关联逻辑
- 只有在**创建单元时选择了宏配置**，才会保存宏ID
- 已存在的单元（创建时未选择宏）不会显示宏信息
- 如果需要为已存在的单元关联宏，需要：
  1. 删除该单元
  2. 重新创建并选择宏配置

### 3. 数据库字段
- `macro_id` 字段允许为 `NULL`
- 删除宏配置不会影响已关联的单元（只是显示为空）

## 故障排查

### 问题1：创建单元后不显示宏配置
**可能原因**：
- 创建时未选择宏配置
- 后端服务未重启（未加载新的字段映射）

**解决方法**：
1. 检查创建单元时是否选择了"应用宏配置"
2. 重启后端服务（在IDE中重新运行 `RuoYiApplication.java`）
3. 清除浏览器缓存并刷新页面

### 问题2：后端报错 "Unknown column 'macro_id'"
**原因**：数据库字段未添加

**解决方法**：
```sql
-- 手动执行SQL
ALTER TABLE sys_baseband_unit 
ADD COLUMN macro_id BIGINT DEFAULT NULL COMMENT '宏配置ID' AFTER mode_type;

ALTER TABLE sys_baseband_unit 
ADD INDEX idx_macro_id (macro_id);
```

### 问题3：显示的宏名称包含单元类型后缀
**原因**：前端去除后缀的逻辑未生效

**解决方法**：
检查 `index.vue` 中的 `groupedUnits` 计算属性：
```javascript
// 提取宏配置名称（取第一个有宏配置的单元的宏名称，并去掉单元类型后缀）
if (unit.macroName && !groups[taskKey].macroName) {
  let macroName = unit.macroName
  // 去掉括号中的单元类型
  const match = macroName.match(/^(.+?)\s*[\(（](编码|调制|解调|译码)[\)）]$/)
  if (match) {
    macroName = match[1]
  }
  groups[taskKey].macroName = macroName
}
```

## 相关文件

### 后端
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/domain/SysBasebandUnit.java`
- `RuoYi-Vue/ruoyi-system/src/main/resources/mapper/system/SysBasebandUnitMapper.xml`

### 前端
- `RuoYi-Vue3/src/views/system/baseband/unit/index.vue`

### 数据库
- `RuoYi-Vue/sql/add_macro_id_to_unit.sql`

---

**创建日期**：2025-12-16  
**状态**：✅ 代码已完成，等待测试
