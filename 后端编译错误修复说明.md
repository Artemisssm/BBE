# 后端编译错误修复说明

## 问题描述

编译时出现两个错误：
```
找不到符号: 方法 selectBasebandUnitById(java.lang.Long)
找不到符号: 方法 selectParamVoByUnitId(java.lang.Long)
```

## 问题原因

`BasebandDispatchServiceImpl.java` 文件调用了不存在的方法，并且缺少相关的依赖类。

## 已修复的问题

### 1. 方法名称错误
- ❌ `selectBasebandUnitById` 
- ✅ `selectSysBasebandUnitByUnitId`

### 2. 缺少的类和接口

#### 2.1 创建了 BasebandParamVo 类
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/domain/vo/BasebandParamVo.java
```
用于参数下发时的数据传输。

#### 2.2 创建了 SysBasebandDispatchLog 实体类
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/domain/SysBasebandDispatchLog.java
```
用于记录参数下发日志。

#### 2.3 创建了 SysBasebandDispatchLogMapper
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/mapper/SysBasebandDispatchLogMapper.java
RuoYi-Vue/ruoyi-system/src/main/resources/mapper/system/SysBasebandDispatchLogMapper.xml
```
用于下发日志的数据库操作。

#### 2.4 创建了 IBasebandDispatchService 接口
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/service/IBasebandDispatchService.java
```
定义参数下发服务接口。

#### 2.5 创建了 BasebandMulticastProperties 配置类
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/config/BasebandMulticastProperties.java
```
用于读取组播配置参数。

### 3. 添加了 Mapper 方法

在 `SysBasebandParamValueMapper` 中添加了：
```java
public List<BasebandParamVo> selectParamVoListByUnitId(Long unitId);
```

对应的 SQL 查询：
```xml
<select id="selectParamVoListByUnitId" parameterType="Long" resultType="com.ruoyi.system.domain.vo.BasebandParamVo">
    SELECT 
        d.param_id,
        d.param_name,
        d.param_code,
        d.hardware_order,
        d.bit_length,
        v.uint_value
    FROM sys_baseband_param_def d
    INNER JOIN sys_baseband_unit u ON d.unit_type = u.unit_type
    LEFT JOIN sys_baseband_param_value v ON v.param_id = d.param_id AND v.unit_id = u.unit_id
    WHERE u.unit_id = #{unitId}
    ORDER BY d.hardware_order
</select>
```

## 新增功能

### 1. 完整的参数下发功能

`BasebandDispatchServiceImpl` 实现了完整的UDP组播下发逻辑：

#### 功能特性
- ✅ 参数验证（检查单元是否存在、参数是否配置）
- ✅ 按硬件顺序排序参数
- ✅ 组装二进制报文（包含CRC16校验）
- ✅ UDP组播发送
- ✅ 下发日志记录（成功/失败）

#### 报文格式
```
+--------+--------+--------+--------+--------+--------+
| 魔数   | 类型   | 单元ID | 参数数 | 参数列表| CRC16  |
| 2字节  | 1字节  | 4字节  | 2字节  | N*10   | 2字节  |
+--------+--------+--------+--------+--------+--------+

魔数: 0xBB66
类型: ENCODE=0x00, MODULATE=0x01, DEMODULATE=0x02, DECODE=0x03
参数列表: 每个参数 = 参数ID(2字节) + uint_value(8字节)
CRC16: Modbus CRC16校验
```

### 2. 组播配置

创建了配置文件 `application-baseband.yml`：
```yaml
baseband:
  multicast:
    address: 239.255.0.1  # 组播地址
    port: 9000            # 组播端口
    ttl: 16               # TTL值
    netIf: eth0           # 网络接口（可选）
```

### 3. 下发日志

所有下发操作都会记录到 `sys_baseband_dispatch_log` 表：
- 下发时间
- 单元ID
- 下发类型（MANUAL/AUTO）
- 组播地址和端口
- 报文长度
- 结果状态（成功/失败）
- 错误消息

## 配置步骤

### 1. 在 application.yml 中引入配置
```yaml
spring:
  profiles:
    include: baseband
```

### 2. 根据实际环境修改组播配置
编辑 `application-baseband.yml`，修改：
- `address`: 组播地址（需要与硬件设备约定）
- `port`: 组播端口
- `netIf`: 网络接口名称（可选）

### 3. 重新编译项目
```bash
cd RuoYi-Vue
mvn clean install
```

## 测试步骤

### 1. 配置参数
1. 登录系统
2. 进入"基带监控 > 基带单元"
3. 新增一个基带单元
4. 点击"参数配置"
5. 配置所有参数并保存

### 2. 下发参数
1. 在参数配置页面点击"下发参数"
2. 系统会通过UDP组播发送参数到硬件设备
3. 查看下发结果提示

### 3. 查看下发日志
可以在数据库中查询 `sys_baseband_dispatch_log` 表查看下发记录：
```sql
SELECT * FROM sys_baseband_dispatch_log ORDER BY log_id DESC LIMIT 10;
```

## 技术细节

### 1. 数据转换流程
```
用户输入 (rawValue)
    ↓
根据参数类型和缩放因子转换
    ↓
无符号整数 (uintValue)
    ↓
按硬件顺序排序
    ↓
组装二进制报文
    ↓
UDP组播发送
```

### 2. 参数类型处理
- **ENUM**: 直接使用枚举值
- **SWITCH**: 0/1 开关值
- **UINT**: 整数 × 缩放因子
- **FLOAT**: 浮点数 × 缩放因子 → 整数

### 3. 错误处理
- 单元不存在 → 抛出异常
- 参数未配置 → 抛出异常
- 网络发送失败 → 记录日志并抛出异常

## 注意事项

1. **网络配置**: 确保服务器网络支持组播，防火墙允许UDP端口
2. **硬件协议**: 报文格式需要与硬件设备协议一致
3. **参数完整性**: 下发前会检查所有参数是否已配置
4. **并发控制**: 当前实现不支持并发下发，如需要可添加分布式锁

## 后续优化建议

1. **下发日志查询页面**: 创建前端页面查看下发历史
2. **批量下发**: 支持一次下发多个单元
3. **定时下发**: 支持定时自动下发
4. **下发确认**: 等待硬件设备的ACK确认
5. **重试机制**: 下发失败时自动重试

## 文件清单

### 新增文件
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/
├── config/
│   └── BasebandMulticastProperties.java
├── domain/
│   ├── SysBasebandDispatchLog.java
│   └── vo/
│       └── BasebandParamVo.java
├── mapper/
│   └── SysBasebandDispatchLogMapper.java
└── service/
    ├── IBasebandDispatchService.java
    └── impl/
        └── BasebandDispatchServiceImpl.java (已存在，已修复)

RuoYi-Vue/ruoyi-system/src/main/resources/mapper/system/
└── SysBasebandDispatchLogMapper.xml

RuoYi-Vue/ruoyi-admin/src/main/resources/
└── application-baseband.yml
```

### 修改文件
```
RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/
├── mapper/
│   └── SysBasebandParamValueMapper.java (添加方法)
└── service/impl/
    └── SysBasebandParamValueServiceImpl.java (集成下发服务)

RuoYi-Vue/ruoyi-system/src/main/resources/mapper/system/
└── SysBasebandParamValueMapper.xml (添加SQL)
```

## 总结

所有编译错误已修复，并实现了完整的参数下发功能。系统现在可以：
- ✅ 正常编译运行
- ✅ 配置基带参数
- ✅ 通过UDP组播下发参数到硬件设备
- ✅ 记录下发日志
- ✅ 处理下发异常

项目已经可以正常使用，后续可以根据实际需求添加更多功能。
