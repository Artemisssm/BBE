# 约束规则优化方案

## 一、约束类型详细定义

### 1. 值范围约束 (VALUE_RANGE)
**场景**：一个值的改变影响另一个值的范围

**示例**：
- 编码方式为CONV时，码率范围为0.5~0.8
- 调制方式为BPSK时，符号率范围为1~100

**约束条件格式**：
```
==CONV  (当源参数等于CONV时)
!=LDPC  (当源参数不等于LDPC时)
>=10    (当源参数大于等于10时)
```

**约束值格式**：
```
0.5,0.8  (最小值,最大值)
```

**前端效果**：
- 动态调整目标参数的min/max范围
- 如果当前值超出新范围，显示警告

### 2. 固定值约束 (FIXED_VALUE)
**场景**：一个值的改变使得另一个值固定取一个值

**示例**：
- ACM启用时，码率固定为0.75
- 环回模式启用时，增益固定为0

**约束条件格式**：
```
==1  (当源参数等于1时)
```

**约束值格式**：
```
0.75  (固定值)
```

**前端效果**：
- 自动设置目标参数为固定值
- 目标参数变为只读（灰色）

### 3. 禁用约束 (ENABLE_DISABLE)
**场景**：一个值的改变影响另一个值取范围或固定值后置灰不能操作

**示例**：
- ACM启用时，禁用手动设置码率
- 自动模式启用时，禁用手动参数配置

**约束条件格式**：
```
==1  (当源参数等于1时)
```

**约束值格式**：
```
（留空或填写禁用时的默认值）
```

**前端效果**：
- 目标参数变为禁用状态（灰色）
- 可选：设置为默认值

### 4. 枚举限制约束 (ENUM_LIMIT)
**场景**：若枚举值被影响，限制可选的枚举选项

**示例**：
- 编码方式为CONV时，码率只能选择：0.5, 0.67, 0.75
- 调制方式为BPSK时，符号率只能选择：1, 2, 5, 10

**约束条件格式**：
```
==CONV  (当源参数等于CONV时)
```

**约束值格式**：
```
0.5,0.67,0.75  (允许的枚举值列表，逗号分隔)
```

**前端效果**：
- 动态过滤枚举选项
- 只显示允许的选项

### 5. 值同步约束 (VALUE_SYNC)
**场景**：两个参数值保持一致

**示例**：
- 编码单元和调制单元的ACM状态必须一致
- 调制和解调的环回状态必须一致

**约束条件格式**：
```
（留空，始终同步）
```

**约束值格式**：
```
（留空）
```

**前端效果**：
- 源参数变化时，自动同步目标参数
- 目标参数可选：只读或可编辑

### 6. 链路模式约束 (LINK_MODE_CONSTRAINT)
**场景**：源参数可以为空，靠链路模式来做约束

**示例**：
- 返向中低速数传链路，符号率范围为1~100
- ACM数传链路，必须启用ACM

**约束条件格式**：
```
（留空，只根据链路模式）
```

**约束值格式**：
```
1,100  (范围约束)
或
1      (固定值约束)
```

**前端效果**：
- 根据链路模式自动应用约束
- 不依赖其他参数

## 二、约束表结构优化

### 新增字段

```sql
ALTER TABLE sys_baseband_param_constraint
ADD COLUMN action_type VARCHAR(20) COMMENT '动作类型：RANGE/FIXED/DISABLE/ENUM_LIMIT/SYNC/AUTO_SET';

ALTER TABLE sys_baseband_param_constraint
ADD COLUMN action_value TEXT COMMENT '动作值：根据action_type不同而不同';

ALTER TABLE sys_baseband_param_constraint
ADD COLUMN ui_effect VARCHAR(20) COMMENT 'UI效果：READONLY/DISABLED/HIDDEN/HIGHLIGHT';
```

### 完整表结构

```sql
CREATE TABLE sys_baseband_param_constraint (
    constraint_id BIGINT NOT NULL AUTO_INCREMENT COMMENT '约束规则主键',
    
    -- 源信息
    source_unit_name VARCHAR(50) COMMENT '源链路模式（*表示通配，NULL表示仅链路约束）',
    source_unit_type VARCHAR(16) COMMENT '源单元类型（*表示通配）',
    source_param_name VARCHAR(64) COMMENT '源参数名称（NULL表示仅链路约束）',
    
    -- 目标信息
    target_unit_name VARCHAR(50) COMMENT '目标链路模式（*表示通配）',
    target_unit_type VARCHAR(16) COMMENT '目标单元类型（*表示通配）',
    target_param_name VARCHAR(64) NOT NULL COMMENT '目标参数名称',
    
    -- 约束条件
    constraint_type VARCHAR(20) NOT NULL COMMENT '约束类型',
    constraint_condition VARCHAR(100) COMMENT '约束条件（如：==1, >=10）',
    constraint_value VARCHAR(200) COMMENT '约束值',
    
    -- 动作定义
    action_type VARCHAR(20) COMMENT '动作类型：RANGE/FIXED/DISABLE/ENUM_LIMIT/SYNC/AUTO_SET',
    action_value TEXT COMMENT '动作值',
    ui_effect VARCHAR(20) COMMENT 'UI效果：READONLY/DISABLED/HIDDEN/HIGHLIGHT',
    
    -- 其他
    priority INT DEFAULT 10 COMMENT '优先级：数字越大优先级越高',
    error_message VARCHAR(500) COMMENT '错误提示信息',
    status CHAR(1) DEFAULT '0' COMMENT '状态：0=正常，1=停用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    remark VARCHAR(500) COMMENT '备注',
    
    PRIMARY KEY (constraint_id),
    KEY idx_source_unit (source_unit_name, source_unit_type),
    KEY idx_target_unit (target_unit_name, target_unit_type),
    KEY idx_source_param (source_param_name),
    KEY idx_target_param (target_param_name),
    KEY idx_priority (priority)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基带参数约束规则表';
```

## 三、约束规则示例

### 示例1：值范围约束
```sql
INSERT INTO sys_baseband_param_constraint (
    source_unit_name, source_unit_type, source_param_name,
    target_unit_name, target_unit_type, target_param_name,
    constraint_type, constraint_condition, constraint_value,
    action_type, action_value, ui_effect,
    priority, error_message, status
) VALUES (
    '返向中低速数传', 'ENCODE', 'ENC_CODE_TYPE',
    '返向中低速数传', 'ENCODE', 'ENC_CODE_RATE',
    'VALUE_RANGE', '==CONV', '0.5,0.8',
    'RANGE', '{"min": 0.5, "max": 0.8}', 'HIGHLIGHT',
    15, '卷积码的码率范围应为0.5~0.8', '0'
);
```

### 示例2：固定值约束
```sql
INSERT INTO sys_baseband_param_constraint VALUES (
    NULL,
    'ACM数传', 'ENCODE', 'ACM_ENABLE',
    'ACM数传', 'ENCODE', 'ENC_CODE_RATE',
    'FIXED_VALUE', '==1', '0.75',
    'FIXED', '{"value": 0.75}', 'READONLY',
    20, 'ACM启用时码率固定为0.75', '0',
    NOW(), NOW(), 'ACM模式固定码率'
);
```

### 示例3：禁用约束
```sql
INSERT INTO sys_baseband_param_constraint VALUES (
    NULL,
    'ACM数传', 'ENCODE', 'ACM_ENABLE',
    'ACM数传', 'ENCODE', 'ENC_CODE_RATE',
    'ENABLE_DISABLE', '==1', '',
    'DISABLE', '{}', 'DISABLED',
    20, 'ACM启用时不能手动设置码率', '0',
    NOW(), NOW(), 'ACM模式禁用手动设置'
);
```

### 示例4：枚举限制约束
```sql
INSERT INTO sys_baseband_param_constraint VALUES (
    NULL,
    '返向中低速数传', 'ENCODE', 'ENC_CODE_TYPE',
    '返向中低速数传', 'ENCODE', 'ENC_CODE_RATE',
    'ENUM_LIMIT', '==CONV', '0.5,0.67,0.75',
    'ENUM_LIMIT', '{"allowedValues": ["0.5", "0.67", "0.75"]}', 'HIGHLIGHT',
    15, '卷积码只能选择这些码率', '0',
    NOW(), NOW(), '限制枚举选项'
);
```

### 示例5：值同步约束
```sql
INSERT INTO sys_baseband_param_constraint VALUES (
    NULL,
    'ACM数传', 'ENCODE', 'ACM_ENABLE',
    'ACM数传', 'MODULATE', 'ACM_ENABLE',
    'VALUE_SYNC', '', '',
    'SYNC', '{"autoSync": true}', 'READONLY',
    20, '编码和调制的ACM状态必须一致', '0',
    NOW(), NOW(), 'ACM状态同步'
);
```

### 示例6：链路模式约束（源参数为空）
```sql
INSERT INTO sys_baseband_param_constraint VALUES (
    NULL,
    '返向中低速数传', 'MODULATE', NULL,  -- 源参数为空
    '返向中低速数传', 'MODULATE', 'MOD_SYMBOL_RATE',
    'VALUE_RANGE', '', '1,100',  -- 条件为空
    'RANGE', '{"min": 1, "max": 100}', 'HIGHLIGHT',
    10, '返向中低速数传的符号率范围为1~100', '0',
    NOW(), NOW(), '链路模式约束'
);
```

## 四、优先级执行顺序

### 原则：优先级高的最后执行生效

**执行顺序**：
1. 查询所有匹配的约束规则
2. 按优先级**从低到高**排序
3. 依次执行约束
4. 后执行的约束会覆盖先执行的约束

**示例**：
```
优先级10：通用约束 - 码率范围0.33~0.75
优先级15：特定约束 - 卷积码码率范围0.5~0.8
优先级20：强制约束 - ACM启用时码率固定0.75

执行顺序：10 → 15 → 20
最终生效：码率固定0.75（优先级20）
```

**SQL查询**：
```sql
SELECT * FROM sys_baseband_param_constraint
WHERE status = '0'
  AND target_param_name = 'ENC_CODE_RATE'
  AND (source_unit_name = '返向中低速数传' OR source_unit_name = '*')
  AND (source_unit_type = 'ENCODE' OR source_unit_type = '*')
ORDER BY priority ASC, constraint_id ASC;  -- 从低到高
```

## 五、前端实现方案

### 1. 约束应用流程

```javascript
// 参数变化时
function handleParamChange(param) {
  // 1. 获取所有相关约束
  const constraints = await getConstraints(param)
  
  // 2. 按优先级排序（从低到高）
  constraints.sort((a, b) => a.priority - b.priority)
  
  // 3. 依次应用约束
  for (const constraint of constraints) {
    applyConstraint(constraint)
  }
  
  // 4. 保存参数
  await saveParam(param)
}
```

### 2. 约束应用函数

```javascript
function applyConstraint(constraint) {
  const targetParam = findParam(constraint.targetParamName)
  
  switch (constraint.actionType) {
    case 'RANGE':
      // 调整范围
      const range = JSON.parse(constraint.actionValue)
      targetParam.minValue = range.min
      targetParam.maxValue = range.max
      break
      
    case 'FIXED':
      // 固定值
      const fixed = JSON.parse(constraint.actionValue)
      targetParam.rawValue = fixed.value
      targetParam.disabled = true
      break
      
    case 'DISABLE':
      // 禁用
      targetParam.disabled = true
      break
      
    case 'ENUM_LIMIT':
      // 限制枚举
      const limit = JSON.parse(constraint.actionValue)
      targetParam.allowedValues = limit.allowedValues
      break
      
    case 'SYNC':
      // 同步值
      const sourceParam = findParam(constraint.sourceParamName)
      targetParam.rawValue = sourceParam.rawValue
      break
      
    case 'AUTO_SET':
      // 自动设置
      const auto = JSON.parse(constraint.actionValue)
      targetParam.rawValue = auto.value
      break
  }
  
  // 应用UI效果
  applyUIEffect(targetParam, constraint.uiEffect)
}
```

### 3. UI效果应用

```javascript
function applyUIEffect(param, effect) {
  switch (effect) {
    case 'READONLY':
      param.disabled = true
      param.style = 'readonly'
      break
      
    case 'DISABLED':
      param.disabled = true
      param.style = 'disabled'
      break
      
    case 'HIDDEN':
      param.visible = false
      break
      
    case 'HIGHLIGHT':
      param.style = 'highlight'
      break
  }
}
```

### 4. 枚举选项过滤

```javascript
function getFilteredEnumOptions(param) {
  const allOptions = JSON.parse(param.enumOptions)
  
  // 如果有枚举限制约束
  if (param.allowedValues) {
    const filtered = {}
    for (const value of param.allowedValues) {
      if (allOptions[value]) {
        filtered[value] = allOptions[value]
      }
    }
    return filtered
  }
  
  return allOptions
}
```

## 六、后端API增强

### 1. 获取约束规则API

```java
/**
 * 获取参数的所有约束规则
 */
@GetMapping("/constraints/{unitName}/{unitType}/{paramName}")
public AjaxResult getParamConstraints(
    @PathVariable String unitName,
    @PathVariable String unitType,
    @PathVariable String paramName
) {
    List<SysBasebandParamConstraint> constraints = 
        constraintService.getParamConstraints(unitName, unitType, paramName);
    return success(constraints);
}
```

### 2. 应用约束API

```java
/**
 * 应用约束并返回受影响的参数
 */
@PostMapping("/apply")
public AjaxResult applyConstraints(@RequestBody Map<String, Object> params) {
    String unitName = (String) params.get("unitName");
    String unitType = (String) params.get("unitType");
    String paramName = (String) params.get("paramName");
    String paramValue = (String) params.get("paramValue");
    
    // 获取受影响的参数及其新状态
    Map<String, Object> affectedParams = 
        constraintService.applyConstraints(unitName, unitType, paramName, paramValue);
    
    return success(affectedParams);
}
```

## 七、配置界面优化

### 1. 约束类型选择

```vue
<el-select v-model="form.constraintType">
  <el-option label="值范围约束" value="VALUE_RANGE" />
  <el-option label="固定值约束" value="FIXED_VALUE" />
  <el-option label="禁用约束" value="ENABLE_DISABLE" />
  <el-option label="枚举限制约束" value="ENUM_LIMIT" />
  <el-option label="值同步约束" value="VALUE_SYNC" />
  <el-option label="链路模式约束" value="LINK_MODE_CONSTRAINT" />
</el-select>
```

### 2. 动作类型选择

```vue
<el-select v-model="form.actionType">
  <el-option label="调整范围" value="RANGE" />
  <el-option label="固定值" value="FIXED" />
  <el-option label="禁用参数" value="DISABLE" />
  <el-option label="限制枚举" value="ENUM_LIMIT" />
  <el-option label="同步值" value="SYNC" />
  <el-option label="自动设置" value="AUTO_SET" />
</el-select>
```

### 3. UI效果选择

```vue
<el-select v-model="form.uiEffect">
  <el-option label="只读（灰色可见）" value="READONLY" />
  <el-option label="禁用（灰色不可操作）" value="DISABLED" />
  <el-option label="隐藏" value="HIDDEN" />
  <el-option label="高亮提示" value="HIGHLIGHT" />
</el-select>
```

### 4. 源参数可选

```vue
<el-form-item label="源参数">
  <el-select v-model="form.sourceParamName" clearable>
    <el-option label="（无）- 仅链路约束" :value="null" />
    <el-option 
      v-for="param in sourceParamOptions"
      :key="param.paramCode"
      :label="param.paramName"
      :value="param.paramCode"
    />
  </el-select>
  <div class="hint">留空表示仅根据链路模式约束，不依赖其他参数</div>
</el-form-item>
```

## 八、使用场景总结

| 场景 | 约束类型 | 动作类型 | UI效果 | 示例 |
|------|----------|----------|--------|------|
| 影响范围 | VALUE_RANGE | RANGE | HIGHLIGHT | 编码方式影响码率范围 |
| 固定值 | FIXED_VALUE | FIXED | READONLY | ACM启用时码率固定 |
| 禁用参数 | ENABLE_DISABLE | DISABLE | DISABLED | ACM启用时禁用手动设置 |
| 限制枚举 | ENUM_LIMIT | ENUM_LIMIT | HIGHLIGHT | 限制可选的枚举选项 |
| 值同步 | VALUE_SYNC | SYNC | READONLY | ACM状态同步 |
| 链路约束 | LINK_MODE_CONSTRAINT | RANGE/FIXED | HIGHLIGHT | 链路模式决定参数范围 |

## 九、实施步骤

1. ✅ 更新数据库表结构（添加新字段）
2. ✅ 更新后端实体类和Service
3. ✅ 实现约束应用逻辑
4. ✅ 更新前端约束管理界面
5. ✅ 实现前端约束应用逻辑
6. ✅ 添加示例约束数据
7. ✅ 测试各种约束场景

## 十、优势

1. **灵活性**：支持多种约束场景
2. **可扩展**：易于添加新的约束类型
3. **优先级**：高优先级约束覆盖低优先级
4. **链路约束**：支持仅基于链路模式的约束
5. **UI友好**：清晰的视觉反馈
6. **易维护**：结构化的约束定义

这个方案完全满足你提出的6个需求！
