# 参数约束配置示例

## 一、界面优化说明

### 1. 单元名称联动
- **源单元名称**和**目标单元名称**自动联动
- 选择源单元名称后，目标单元名称自动同步
- 原因：约束通常发生在同一单元名称下的不同单元类型之间

### 2. 支持同类型约束
- **源单元类型**和**目标单元类型**可以相同
- 例如：调制单元内部参数之间的约束
- 场景：调制方式影响符号率（都在调制单元内）

### 3. 参数选择器
- 从参数定义中选择参数
- 显示格式：**参数名称 (参数代码)**
- 自动填充参数代码到表单
- 支持搜索和筛选

## 二、配置示例

### 示例1：单元内部约束（同类型）

**场景**：调制单元内部，调制方式影响符号率范围

**配置步骤**：
1. 点击"新增"按钮
2. 填写表单：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源单元名称 | 返向中低速数传 | 选择单元名称 |
| 源单元类型 | 调制单元 | 选择类型 |
| 源参数 | 调制方式 (MOD_TYPE) | 从下拉列表选择 |
| 目标单元名称 | 返向中低速数传 | 自动同步 |
| 目标单元类型 | 调制单元 | **与源类型相同** |
| 目标参数 | 符号率 (MOD_SYMBOL_RATE) | 从下拉列表选择 |
| 约束类型 | 值范围约束 | |
| 约束条件 | ==BPSK | 当调制方式为BPSK时 |
| 约束值 | 1,100 | 符号率范围1~100 |
| 优先级 | 15 | 重要约束 |
| 错误提示 | BPSK调制的符号率范围应为1~100 Msps | |

### 示例2：跨单元类型约束（同单元名称）

**场景**：返向中低速数传，编码单元的编码方式影响调制单元的码率

**配置步骤**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源单元名称 | 返向中低速数传 | |
| 源单元类型 | 编码单元 | |
| 源参数 | 编码方式 (ENC_CODE_TYPE) | |
| 目标单元名称 | 返向中低速数传 | **与源单元名称相同** |
| 目标单元类型 | 编码单元 | 也可以是调制单元 |
| 目标参数 | 编码码率 (ENC_CODE_RATE) | |
| 约束类型 | 值范围约束 | |
| 约束条件 | ==CONV | 当编码方式为卷积码时 |
| 约束值 | 0.5,0.8 | 码率范围0.5~0.8 |
| 优先级 | 15 | |
| 错误提示 | 返向中低速数传卷积码的码率范围应为0.5~0.8 | |

### 示例3：通用约束（使用通配符）

**场景**：所有编码单元的卷积码码率范围

**配置步骤**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源单元名称 | * | **通配符** |
| 源单元类型 | 编码单元 | |
| 源参数 | 编码方式 (ENC_CODE_TYPE) | |
| 目标单元名称 | * | **通配符** |
| 目标单元类型 | 编码单元 | |
| 目标参数 | 编码码率 (ENC_CODE_RATE) | |
| 约束类型 | 值范围约束 | |
| 约束条件 | ==CONV | |
| 约束值 | 0.33,0.75 | |
| 优先级 | 10 | **低于特定单元约束** |
| 错误提示 | 卷积码的码率范围应为0.33~0.75 | |

### 示例4：启用/禁用约束

**场景**：ACM启用时，禁用手动设置码率

**配置步骤**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源单元名称 | ACM数传 | |
| 源单元类型 | 编码单元 | |
| 源参数 | ACM使能 (ACM_ENABLE) | |
| 目标单元名称 | ACM数传 | |
| 目标单元类型 | 编码单元 | **同类型** |
| 目标参数 | 编码码率 (ENC_CODE_RATE) | |
| 约束类型 | 启用/禁用约束 | |
| 约束条件 | ==1 | 当ACM启用时 |
| 约束值 | （留空） | |
| 优先级 | 20 | **强制约束** |
| 错误提示 | ACM启用时不能手动设置码率 | |

### 示例5：值同步约束

**场景**：编码单元和调制单元的ACM状态必须一致

**配置步骤**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源单元名称 | ACM数传 | |
| 源单元类型 | 编码单元 | |
| 源参数 | ACM使能 (ACM_ENABLE) | |
| 目标单元名称 | ACM数传 | **同单元名称** |
| 目标单元类型 | 调制单元 | **不同类型** |
| 目标参数 | ACM使能 (ACM_ENABLE) | |
| 约束类型 | 值同步约束 | |
| 约束条件 | （留空） | |
| 约束值 | （留空） | |
| 优先级 | 20 | |
| 错误提示 | 编码和调制的ACM状态必须一致 | |

### 示例6：前向数传小环的环回约束

**场景**：前向数传小环必须启用环回模式

**配置步骤**：

| 字段 | 值 | 说明 |
|------|-----|------|
| 源单元名称 | 前向数传小环 | |
| 源单元类型 | 调制单元 | |
| 源参数 | 调制环回使能 (MOD_LOOPBACK_EN) | |
| 目标单元名称 | 前向数传小环 | |
| 目标单元类型 | 解调单元 | **不同类型** |
| 目标参数 | 解调环回使能 (DEMOD_LOOPBACK_EN) | |
| 约束类型 | 值同步约束 | |
| 约束条件 | （留空） | |
| 约束值 | （留空） | |
| 优先级 | 20 | |
| 错误提示 | 调制和解调的环回状态必须一致 | |

## 三、约束类型详解

### 1. 值范围约束（VALUE_RANGE）

**用途**：限制目标参数的取值范围

**约束条件**：
- `==值` - 当源参数等于某值时
- `!=值` - 当源参数不等于某值时
- `>值` - 当源参数大于某值时
- `<值` - 当源参数小于某值时
- `>=值` - 当源参数大于等于某值时
- `<=值` - 当源参数小于等于某值时

**约束值格式**：`最小值,最大值`

**示例**：
```
约束条件: ==CONV
约束值: 0.5,0.8
含义: 当编码方式为CONV时，码率范围为0.5~0.8
```

### 2. 启用/禁用约束（ENABLE_DISABLE）

**用途**：根据源参数值禁用目标参数

**约束条件**：同值范围约束

**约束值**：留空

**示例**：
```
约束条件: ==1
约束值: （留空）
含义: 当源参数为1时，禁用目标参数
```

### 3. 值同步约束（VALUE_SYNC）

**用途**：源参数和目标参数值保持一致

**约束条件**：留空

**约束值**：留空

**示例**：
```
约束条件: （留空）
约束值: （留空）
含义: 源参数和目标参数值始终保持一致
```

### 4. 值计算约束（VALUE_CALCULATE）

**用途**：根据公式计算目标参数值

**约束条件**：留空

**约束值**：公式表达式

**示例**：
```
约束条件: （留空）
约束值: source * 2
含义: 目标参数 = 源参数 × 2
```

## 四、优先级说明

### 优先级范围：0-100

| 范围 | 级别 | 说明 | 示例 |
|------|------|------|------|
| 20+ | 强制约束 | 必须满足，不可违反 | ACM联动、环回联动 |
| 10-19 | 重要约束 | 应该满足，影响功能 | 编码方式影响码率范围 |
| 1-9 | 一般约束 | 建议满足，优化性能 | 推荐的参数范围 |
| 0 | 提示性约束 | 仅提示，不阻止保存 | 参数建议值 |

### 匹配优先级

当多个约束规则匹配时，按以下顺序：

1. **精确匹配**（单元名称 + 单元类型）- 优先级最高
   ```
   源单元名称: 返向中低速数传
   源单元类型: 编码单元
   ```

2. **单元名称通配**（* + 单元类型）
   ```
   源单元名称: *
   源单元类型: 编码单元
   ```

3. **单元类型通配**（单元名称 + *）
   ```
   源单元名称: 返向中低速数传
   源单元类型: *
   ```

4. **全通配**（* + *）- 优先级最低
   ```
   源单元名称: *
   源单元类型: *
   ```

**建议**：
- 通用约束使用优先级 10
- 特定单元约束使用优先级 15
- 强制约束使用优先级 20+

## 五、常见配置场景

### 场景1：编码方式影响码率

```
源: 编码方式 → 目标: 编码码率
同单元名称，同单元类型（编码单元）
```

### 场景2：调制方式影响符号率

```
源: 调制方式 → 目标: 符号率
同单元名称，同单元类型（调制单元）
```

### 场景3：ACM联动

```
源: 编码ACM使能 → 目标: 调制ACM使能
同单元名称，不同单元类型（编码→调制）
```

### 场景4：环回联动

```
源: 调制环回使能 → 目标: 解调环回使能
同单元名称，不同单元类型（调制→解调）
```

### 场景5：帧长度同步

```
源: 编码帧长度 → 目标: 调制帧长度
同单元名称，不同单元类型（编码→调制）
```

## 六、操作技巧

### 1. 快速创建约束

1. 先选择单元名称（会自动同步到目标）
2. 选择源单元类型（参数列表自动加载）
3. 从下拉列表选择源参数（显示中文名称）
4. 选择目标单元类型（可以与源相同）
5. 从下拉列表选择目标参数
6. 选择约束类型
7. 填写约束条件和值
8. 设置优先级
9. 填写错误提示

### 2. 使用通配符

- 创建通用约束时，单元名称选择 `*`
- 优先级设置为 10（低于特定单元约束）
- 后续可以为特定单元创建优先级更高的约束

### 3. 测试约束

1. 保存约束后，到参数配置界面
2. 修改源参数的值
3. 观察目标参数是否受到约束
4. 查看错误提示是否正确显示

### 4. 调试约束

- 查看后端日志，确认约束是否被查询到
- 检查约束条件和约束值格式是否正确
- 确认参数代码是否正确（区分大小写）
- 验证优先级设置是否合理

## 七、注意事项

1. **参数代码**：必须与参数定义中的 `paramCode` 完全一致（区分大小写）
2. **单元名称**：必须与基带单元中的单元名称完全一致
3. **约束条件**：格式必须正确（如：`==CONV`，不能有多余空格）
4. **约束值**：值范围约束必须是 `最小值,最大值` 格式
5. **优先级**：特定单元约束的优先级应高于通配约束
6. **状态**：只有状态为"正常"的约束才会生效

## 八、FAQ

### Q1：为什么参数下拉列表是空的？

**A**：需要先选择单元类型，参数列表会根据单元类型自动加载。

### Q2：源和目标可以是同一个参数吗？

**A**：不建议。约束是源参数影响目标参数，同一个参数没有意义。

### Q3：如何创建跨单元名称的约束？

**A**：不建议。约束通常发生在同一单元名称内。如果确实需要，可以手动修改目标单元名称。

### Q4：约束不生效怎么办？

**A**：
1. 检查约束状态是否为"正常"
2. 检查参数代码是否正确
3. 查看后端日志
4. 验证约束条件格式

### Q5：如何删除所有约束重新配置？

**A**：在约束管理界面，选择所有约束，点击批量删除。或执行SQL：
```sql
TRUNCATE TABLE sys_baseband_param_constraint;
```

## 九、最佳实践

1. **先创建通用约束**（优先级10），再创建特定约束（优先级15+）
2. **使用清晰的错误提示**，帮助用户理解约束原因
3. **合理设置优先级**，避免约束冲突
4. **定期检查约束**，删除不再需要的约束
5. **测试约束**，确保约束逻辑正确
6. **文档化约束**，记录约束的业务含义

## 十、总结

优化后的约束管理界面：
- ✅ 单元名称自动联动
- ✅ 支持同类型约束
- ✅ 参数选择器（显示中文名称）
- ✅ 详细的使用说明
- ✅ 智能的表单提示
- ✅ 约束类型详细说明

让约束配置更加直观、简单、不易出错！
