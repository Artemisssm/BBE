# 基带单元宏参数自动应用说明

## 功能描述

在创建基带单元时，如果选择了宏配置，系统会自动将宏中预设的参数值复制到新创建的单元中。

## 实现逻辑

### 1. 前端（已完成）
在 `submitForm()` 方法中，批量创建单元时会根据选择的宏任务为每个单元类型匹配对应的宏ID：

```javascript
// 查找对应的宏ID
let macroId = null
if (form.value.macroTaskKey && selectedMacroTask.value) {
  const matchingMacro = selectedMacroTask.value.macros.find(macro => macro.unitType === unitType)
  if (matchingMacro) {
    macroId = matchingMacro.macroId
  }
}

const unitData = {
  // ... 其他字段
  macroId: macroId  // 添加宏ID
}
```

### 2. 后端（新增）
在 `SysBasebandUnitServiceImpl.insertSysBasebandUnit()` 方法中，创建单元后会自动复制宏参数：

```java
@Override
@Transactional
public int insertSysBasebandUnit(SysBasebandUnit sysBasebandUnit)
{
    sysBasebandUnit.setCreateTime(DateUtils.getNowDate());
    int result = sysBasebandUnitMapper.insertSysBasebandUnit(sysBasebandUnit);
    
    // 如果指定了宏配置，复制宏参数到单元参数值表
    if (result > 0 && sysBasebandUnit.getMacroId() != null) {
        copyMacroParamsToUnit(sysBasebandUnit.getUnitId(), sysBasebandUnit.getMacroId());
    }
    
    return result;
}

/**
 * 复制宏参数到单元参数值表
 */
private void copyMacroParamsToUnit(Long unitId, Long macroId)
{
    // 获取宏的参数配置
    List<Map<String, Object>> macroParams = macroParamMapper.selectMacroParams(macroId);
    
    if (macroParams == null || macroParams.isEmpty()) {
        return;
    }
    
    // 复制每个参数到单元参数值表
    for (Map<String, Object> param : macroParams) {
        Long paramId = ((Number) param.get("paramId")).longValue();
        String paramValue = (String) param.get("paramValue");
        
        if (paramId != null && paramValue != null) {
            SysBasebandParamValue value = new SysBasebandParamValue();
            value.setUnitId(unitId);
            value.setParamId(paramId);
            value.setRawValue(paramValue);
            value.setUpdateTime(DateUtils.getNowDate());
            
            paramValueMapper.insertSysBasebandParamValue(value);
        }
    }
}
```

## 数据流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           创建基带单元流程                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 用户选择宏配置                                                       │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │ 应用宏配置: [卫星1 ▼]                                        │    │
│     │   - 卫星1 (包含: 编码、调制、解调、译码)                      │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                              │                                          │
│                              ▼                                          │
│  2. 前端匹配宏ID                                                        │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │ 单元类型: ENCODE  →  匹配宏: 卫星1(编码)  →  macroId: 1      │    │
│     │ 单元类型: MODULATE →  匹配宏: 卫星1(调制)  →  macroId: 2     │    │
│     │ 单元类型: DEMODULATE → 匹配宏: 卫星1(解调) → macroId: 3      │    │
│     │ 单元类型: DECODE  →  匹配宏: 卫星1(译码)  →  macroId: 4      │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                              │                                          │
│                              ▼                                          │
│  3. 后端创建单元并复制参数                                               │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │ a. 插入 sys_baseband_unit 表                                 │    │
│     │    - unit_id: 100                                            │    │
│     │    - macro_id: 1                                             │    │
│     │                                                              │    │
│     │ b. 查询 sys_baseband_macro_param 表 (macro_id=1)             │    │
│     │    - param_id: 10, param_value: "1000"                       │    │
│     │    - param_id: 11, param_value: "2"                          │    │
│     │                                                              │    │
│     │ c. 插入 sys_baseband_param_value 表                          │    │
│     │    - unit_id: 100, param_id: 10, raw_value: "1000"           │    │
│     │    - unit_id: 100, param_id: 11, raw_value: "2"              │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 使用方式

### 步骤1：创建宏任务并配置参数
1. 进入：基带监控 > 宏管理
2. 点击"新增"，创建宏任务（如"卫星1"）
3. 为每个单元类型的宏配置参数

### 步骤2：使用宏创建基带单元
1. 进入：基带监控 > 基带单元
2. 点击"新增"
3. 选择链路模式、单元类型、模式类型、板卡资源
4. **在"应用宏配置"下拉框中选择宏任务**
5. 点击"确定"

### 步骤3：验证参数已应用
1. 找到新创建的单元
2. 点击"配置"按钮
3. 查看参数值是否已自动填充为宏中预设的值

## 注意事项

### 1. 宏参数匹配规则
- 根据单元类型匹配对应的宏
- 例如：创建编码单元时，使用"卫星1(编码)"宏的参数

### 2. 参数覆盖
- 如果单元已有参数值，不会被覆盖
- 只有新创建的单元才会自动应用宏参数

### 3. 事务处理
- 创建单元和复制参数在同一个事务中
- 如果复制参数失败，整个创建操作会回滚

### 4. 空宏处理
- 如果宏没有配置任何参数，单元会正常创建
- 参数值表不会有任何记录

## 相关文件

### 后端
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysBasebandUnitServiceImpl.java`

### 前端
- `RuoYi-Vue3/src/views/system/baseband/unit/index.vue`

### 数据库表
- `sys_baseband_unit` - 基带单元表（包含 macro_id 字段）
- `sys_baseband_macro_param` - 宏参数配置表
- `sys_baseband_param_value` - 单元参数值表

---

**创建日期**：2025-12-16  
**状态**：✅ 已完成
