# 基带单元资源管理功能说明

## 🎯 功能概述

实现了智能的板卡资源管理系统，支持：
1. **批量创建单元** - 一次可创建多个不同类型的单元
2. **智能资源分配** - 自动管理板卡和FPGA资源
3. **约束检查** - 返向高速占整板，其他占单FPGA
4. **冲突避免** - 已占用资源自动禁用

## 📋 硬件资源配置

### 板卡配置
- **板卡数量**: 4块板（可配置）
- **每板FPGA数**: 2个（FPGA0和FPGA1）
- **总资源数**: 8个FPGA

### 通道号映射
```
板1-FPGA0 → 通道1
板1-FPGA1 → 通道2
板2-FPGA0 → 通道3
板2-FPGA1 → 通道4
板3-FPGA0 → 通道5
板3-FPGA1 → 通道6
板4-FPGA0 → 通道7
板4-FPGA1 → 通道8
```

## 🔧 资源占用规则

### 1. 返向高速模式
- **占用资源**: 整块板（FPGA0 + FPGA1）
- **显示格式**: "板X（整板）"
- **约束**: 该板的两个FPGA都不可用

### 2. 其他模式
- **占用资源**: 单个FPGA
- **显示格式**: "板X-FPGAY"
- **约束**: 只占用选中的FPGA

### 3. 资源冲突检测
- ✅ 已占用的FPGA不可选
- ✅ 被返向高速占用的整板不可选
- ✅ 两个FPGA都被占用的板标记为整板占用

## 💡 使用场景

### 场景1：批量创建单元

**需求**: 为"前向中低速"创建编码、调制、解调、译码四个单元

**操作步骤**:
1. 点击"新增"按钮
2. 选择单元名称："前向中低速"
3. 勾选单元类型：☑️编码 ☑️调制 ☑️解调 ☑️译码
4. 选择板卡资源："板1-FPGA0"
5. 点击"确定"

**结果**: 
- 创建4个单元，都使用"板1-FPGA0"
- 系统提示："成功创建 4 个基带单元"
- "板1-FPGA0"被标记为已占用

### 场景2：返向高速占用整板

**需求**: 创建返向高速单元

**操作步骤**:
1. 点击"新增"按钮
2. 选择单元名称："返向高速"
3. 勾选单元类型：☑️调制
4. 选择板卡资源："板2（整板）"
5. 系统提示：⚠️ 返向高速需要占用整块板（FPGA0和FPGA1）
6. 点击"确定"

**结果**:
- 创建1个返向高速单元
- "板2-FPGA0"和"板2-FPGA1"都被占用
- 后续添加时，板2的所有选项都显示为禁用

### 场景3：资源不足提示

**需求**: 尝试选择已占用的资源

**显示效果**:
```
板卡资源下拉框：
├─ 板1-FPGA0 (FPGA已被占用)  [禁用]
├─ 板1-FPGA1                 [可选]
├─ 板2（整板）(板卡已被占用) [禁用]
├─ 板3-FPGA0                 [可选]
└─ 板3-FPGA1                 [可选]
```

## 🎨 界面设计

### 新增对话框
```
┌─────────────────────────────────────────────┐
│ 批量添加基带单元                             │
├─────────────────────────────────────────────┤
│                                              │
│ 单元名称: [前向中低速 ▼]                     │
│                                              │
│ 单元类型: ☑️编码  ☑️调制  ☑️解调  ☑️译码      │
│          可同时选择多个类型，将批量创建单元   │
│                                              │
│ 板卡资源: [板1-FPGA0 ▼]                      │
│          ℹ️ 该模式只占用一个FPGA              │
│                                              │
│ 版本:     [v1.0]                             │
│ 状态:     ○ 正常  ○ 停用                    │
│ 备注:     [请输入内容]                       │
│                                              │
│                    [确定]  [取消]            │
└─────────────────────────────────────────────┘
```

### 返向高速模式
```
┌─────────────────────────────────────────────┐
│ 批量添加基带单元                             │
├─────────────────────────────────────────────┤
│                                              │
│ 单元名称: [返向高速 ▼]                       │
│                                              │
│ 单元类型: ☑️编码  ☑️调制  ☑️解调  ☑️译码      │
│          可同时选择多个类型，将批量创建单元   │
│                                              │
│ 板卡资源: [板2（整板）▼]                     │
│          ⚠️ 返向高速需要占用整块板           │
│             （FPGA0和FPGA1）                 │
│                                              │
│ 版本:     [v1.0]                             │
│ 状态:     ○ 正常  ○ 停用                    │
│ 备注:     [请输入内容]                       │
│                                              │
│                    [确定]  [取消]            │
└─────────────────────────────────────────────┘
```

## 🔍 资源占用示例

### 示例1：混合占用
```
板1-FPGA0: 前向中低速（编码、调制、解调、译码）
板1-FPGA1: 小环（编码、调制）
板2: 返向高速（调制）[整板占用]
板3-FPGA0: ACM数传（编码）
板3-FPGA1: [空闲]
板4-FPGA0: [空闲]
板4-FPGA1: [空闲]
```

### 示例2：资源状态
```
可用资源列表：
✅ 板3-FPGA1 - 可选
✅ 板4-FPGA0 - 可选
✅ 板4-FPGA1 - 可选
❌ 板1-FPGA0 - FPGA已被占用
❌ 板1-FPGA1 - FPGA已被占用
❌ 板2（整板）- 板卡已被占用
❌ 板3-FPGA0 - FPGA已被占用
```

## 💻 技术实现

### 1. 资源数据结构
```javascript
// 已占用资源集合
occupiedResources = Set {
  'board-2',    // 板2整板被占用
  '1-0',        // 板1-FPGA0被占用
  '1-1',        // 板1-FPGA1被占用
  '3-0'         // 板3-FPGA0被占用
}
```

### 2. 资源检查逻辑
```javascript
// 返向高速检查
if (unitName === '返向高速') {
  // 检查整块板是否可用
  const boardOccupied = 
    occupiedResources.has(`board-${board}`) ||
    occupiedResources.has(`${board}-0`) ||
    occupiedResources.has(`${board}-1`)
}

// 其他模式检查
else {
  // 检查单个FPGA是否可用
  const fpgaOccupied = occupiedResources.has(`${board}-${fpga}`)
  const boardOccupied = occupiedResources.has(`board-${board}`)
}
```

### 3. 批量创建逻辑
```javascript
// 为每个选中的单元类型创建单元
const promises = unitTypes.map(unitType => {
  return addBasebandUnit({
    unitName: form.unitName,
    unitType: unitType,
    channelNo: form.channelNo,
    ...
  })
})

// 并发执行
Promise.all(promises).then(() => {
  msgSuccess(`成功创建 ${unitTypes.length} 个基带单元`)
})
```

## 📊 配置参数

### 可调整参数
```javascript
// 在代码中修改这些常量
const totalBoards = 4        // 板卡总数（默认4块）
const fpgasPerBoard = 2      // 每板FPGA数（默认2个）
```

### 扩展到更多板卡
```javascript
// 例如：8块板
const totalBoards = 8
// 结果：16个FPGA资源（通道1-16）
```

## ⚠️ 注意事项

### 1. 资源分配
- 同一个FPGA可以运行多个不同类型的单元
- 返向高速必须独占整块板
- 建议合理规划资源，避免浪费

### 2. 修改限制
- 修改单元时，单元类型只能选择一个
- 修改时可以更换板卡资源（如果可用）
- 修改单元名称时需要重新检查资源约束

### 3. 删除影响
- 删除单元后，其占用的资源会自动释放
- 刷新页面后资源状态会更新

## 🔄 工作流程

### 新增流程
```
1. 点击"新增"
   ↓
2. 系统加载已占用资源
   ↓
3. 选择单元名称
   ↓
4. 系统更新可用资源列表
   ↓
5. 勾选单元类型（可多选）
   ↓
6. 选择板卡资源
   ↓
7. 填写其他信息
   ↓
8. 提交 → 批量创建
   ↓
9. 更新资源占用状态
```

### 资源更新流程
```
查询单元列表
   ↓
遍历所有单元
   ↓
计算每个单元的资源占用
   ↓
更新 occupiedResources 集合
   ↓
生成可用资源列表
   ↓
标记禁用状态和原因
```

## 🎯 优化效果

| 功能 | 优化前 | 优化后 |
|-----|-------|-------|
| 创建效率 | 一次一个 | 一次多个 |
| 资源管理 | 手动记录 | 自动管理 |
| 冲突检测 | 无 | 自动检测 |
| 用户体验 | 一般 | 优秀 |
| 错误率 | 较高 | 极低 |

## ✅ 测试清单

- [ ] 批量创建多个单元类型
- [ ] 返向高速占用整板
- [ ] 其他模式占用单FPGA
- [ ] 已占用资源显示禁用
- [ ] 禁用原因正确显示
- [ ] 删除单元后资源释放
- [ ] 修改单元功能正常
- [ ] 资源耗尽时提示
- [ ] 分页后资源状态正确

## 🚀 后续优化

1. **资源可视化** - 添加板卡资源占用图表
2. **资源预警** - 资源不足时提前提醒
3. **资源统计** - 显示资源使用率
4. **资源预留** - 支持预留资源功能
5. **资源导出** - 导出资源分配表

---

**版本**: v2.0  
**更新时间**: 2025-11-30  
**状态**: ✅ 已完成
