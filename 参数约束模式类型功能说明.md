# 参数约束模式类型功能说明

## 功能概述

为参数约束关系添加了"模式类型"字段，支持为不同模式类型配置不同的约束关系。由于大部分约束关系在不同模式下相同，因此采用勾选框方式，不勾选表示适用于所有模式。

## 主要特性

### 1. 模式类型支持
- **KSA**：K波段单天线模式
- **KMA**：K波段多天线模式
- **SSA**：S波段单天线模式
- **基带数传**：基带数传模式

### 2. 灵活配置
- **不勾选任何模式**：约束适用于所有模式类型（推荐用于通用约束）
- **勾选特定模式**：约束仅适用于选中的模式类型
- **勾选多个模式**：约束适用于多个模式类型

### 3. 使用场景

#### 场景1：通用约束（大部分情况）
大部分约束关系在不同模式下都相同，例如：
- 码率范围约束：0.5~0.8
- 调制方式与码率的关联

**配置方式**：不勾选任何模式类型，留空即可

#### 场景2：模式特定约束
某些约束仅在特定模式下生效，例如：
- KSA模式下的特殊参数限制
- 基带数传模式的独有约束

**配置方式**：勾选对应的模式类型

#### 场景3：多模式共享约束
某些约束在几个模式下相同，但不是全部，例如：
- KSA和KMA共享的约束
- SSA和基带数传共享的约束

**配置方式**：勾选多个相关的模式类型

## 数据库变更

### 新增字段
```sql
ALTER TABLE sys_baseband_param_constraint 
ADD COLUMN mode_types VARCHAR(200) DEFAULT NULL 
COMMENT '适用模式类型（多个用逗号分隔，如：KSA,KMA，空表示适用所有模式）' 
AFTER target_param_name;
```

### 字段说明
- **字段名**：`mode_types`
- **类型**：VARCHAR(200)
- **可空**：是
- **默认值**：NULL
- **存储格式**：多个模式用逗号分隔，如 "KSA,KMA"
- **空值含义**：适用于所有模式类型

## 前端界面

### 列表页面
在约束列表中新增"模式类型"列，显示方式：
- 有值：显示多个标签（如：KSA、KMA）
- 无值：显示"全部模式"标签

### 编辑表单
在约束规则部分添加"适用模式类型"勾选框组：
```
□ KSA  □ KMA  □ SSA  □ 基带数传
```

提示信息：不勾选任何模式表示适用于所有模式类型。大部分约束在不同模式下相同，可以不勾选。

## 后端实现

### 实体类更新
`SysBasebandParamConstraint.java` 新增字段：
```java
/** 适用模式类型（多个用逗号分隔） */
@Excel(name = "模式类型")
private String modeTypes;
```

### Mapper更新
1. 查询时包含 `mode_types` 字段
2. 查询条件支持模式类型筛选（使用 FIND_IN_SET）
3. 插入和更新操作支持 `mode_types` 字段

### 查询逻辑
```xml
<if test="modeTypes != null and modeTypes != ''">
  and (mode_types is null or mode_types = '' or FIND_IN_SET(#{modeTypes}, mode_types) > 0)
</if>
```

## 部署步骤

### 1. 执行数据库脚本
```bash
cd RuoYi-Vue/sql
add_mode_types_to_constraint.bat
```

或手动执行：
```bash
mysql -uroot -p ry-vue < add_mode_types_to_constraint.sql
```

### 2. 重新编译后端
```bash
cd RuoYi-Vue
mvn clean package
```

### 3. 重启后端服务
```bash
cd ruoyi-admin/target
java -jar ruoyi-admin.jar
```

### 4. 前端无需重新构建
前端代码已更新，刷新浏览器即可看到新功能。

## 使用建议

### 1. 优先使用通用约束
- 大部分约束关系在不同模式下相同
- 不勾选模式类型，让约束适用于所有模式
- 减少重复配置，便于维护

### 2. 仅在必要时指定模式
- 只有当约束确实只适用于特定模式时才勾选
- 例如：某个参数只在KSA模式下有效

### 3. 利用优先级机制
- 如果需要为特定模式覆盖通用约束
- 创建一个指定模式的约束，设置更高的优先级
- 系统会优先应用高优先级的约束

## 示例

### 示例1：通用码率约束
```
源参数：调制方式 = QPSK
目标参数：码率
约束类型：值范围约束
约束值：0.5,0.8
模式类型：（不勾选）
```
→ 适用于所有模式

### 示例2：KSA特定约束
```
源参数：天线数量 = 1
目标参数：增益
约束类型：值范围约束
约束值：10,20
模式类型：☑ KSA
```
→ 仅适用于KSA模式

### 示例3：多模式共享约束
```
源参数：频段 = K
目标参数：功率
约束类型：值范围约束
约束值：100,200
模式类型：☑ KSA  ☑ KMA
```
→ 适用于KSA和KMA模式

## 注意事项

1. **向后兼容**：已有约束的 `mode_types` 字段为空，表示适用于所有模式
2. **查询优化**：使用 FIND_IN_SET 函数进行模式匹配
3. **数据一致性**：模式类型值应与基带单元表中的 `mode_type` 字段保持一致
4. **性能考虑**：如果约束数量很大，建议为 `mode_types` 字段添加索引

## 相关文件

### 数据库脚本
- `RuoYi-Vue/sql/add_mode_types_to_constraint.sql`
- `RuoYi-Vue/sql/add_mode_types_to_constraint.bat`

### 后端文件
- `SysBasebandParamConstraint.java` - 实体类
- `SysBasebandParamConstraintMapper.xml` - Mapper配置

### 前端文件
- `RuoYi-Vue3/src/views/system/baseband/paramConstraint/index.vue` - 约束管理页面

## 更新日期
2024-12-02
