# 参数约束功能部署指南

## 一、功能概述

参数约束管理功能允许你：
- 查看所有参数约束规则
- 添加新的约束规则
- 修改现有约束规则
- 删除不需要的约束规则
- 启用/停用约束规则

## 二、部署步骤

### 步骤1：修复数据库表结构

**问题**：数据库表字段名与代码不一致

**解决方案**：执行修复SQL

#### 方法A：使用批处理脚本（推荐）

1. 双击运行：`RuoYi-Vue/sql/fix_database.bat`
2. 输入数据库密码
3. 等待执行完成

#### 方法B：手动执行SQL

```bash
cd RuoYi-Vue/sql
mysql -u root -p ry-vue < fix_param_constraint_table.sql
```

#### 方法C：使用数据库工具

1. 打开Navicat/DBeaver/MySQL Workbench
2. 连接到数据库
3. 打开并执行：`RuoYi-Vue/sql/fix_param_constraint_table.sql`

**验证**：执行以下SQL检查表结构

```sql
DESC sys_baseband_param_constraint;
```

应该看到以下字段：
- `source_param_name` ✓
- `target_param_name` ✓

### 步骤2：添加菜单

**目标**：在基带监控菜单下添加"参数约束"选项

#### 方法A：使用批处理脚本（推荐）

1. 双击运行：`RuoYi-Vue/sql/add_constraint_menu.bat`
2. 输入数据库密码
3. 等待执行完成

#### 方法B：手动执行SQL

```bash
cd RuoYi-Vue/sql
mysql -u root -p ry-vue < add_constraint_menu.sql
```

#### 方法C：使用数据库工具

1. 打开数据库工具
2. 连接到数据库
3. 打开并执行：`RuoYi-Vue/sql/add_constraint_menu.sql`

**验证**：执行以下SQL检查菜单

```sql
SELECT 
    m1.menu_name AS '主菜单',
    m2.menu_name AS '子菜单',
    m2.path AS '路由',
    m2.component AS '组件'
FROM sys_menu m1
LEFT JOIN sys_menu m2 ON m1.menu_id = m2.parent_id
WHERE m1.menu_name = '基带监控'
ORDER BY m2.order_num;
```

应该看到：
- 基带单元
- 参数定义
- **参数约束** ← 新添加的

### 步骤3：重启应用

1. 停止Spring Boot应用
2. 重新启动应用
3. 等待启动完成

### 步骤4：刷新浏览器

1. 打开浏览器
2. 按 `Ctrl + F5` 强制刷新
3. 重新登录系统

### 步骤5：访问约束管理界面

1. 在左侧菜单找到：**基带监控** → **参数约束**
2. 点击进入约束管理界面

## 三、界面功能说明

### 1. 约束列表

显示所有约束规则，包括：
- **源单元**：约束的源参数所在单元
- **源参数**：触发约束的参数
- **目标单元**：被约束的参数所在单元
- **目标参数**：被约束的参数
- **约束类型**：
  - 值范围（VALUE_RANGE）
  - 启用/禁用（ENABLE_DISABLE）
  - 值同步（VALUE_SYNC）
  - 值计算（VALUE_CALCULATE）
- **约束条件**：触发条件（如：==1, >=10）
- **约束值**：约束的具体值（如：0.5,0.8）
- **优先级**：数字越大优先级越高
- **状态**：启用/停用开关

### 2. 搜索和筛选

- **源单元名称**：按单元名称搜索
- **源单元类型**：按单元类型筛选（编码/调制/解调/译码）
- **约束类型**：按约束类型筛选
- **状态**：按启用/停用状态筛选

### 3. 操作按钮

- **新增**：添加新的约束规则
- **修改**：编辑现有约束规则
- **删除**：删除约束规则
- **状态开关**：快速启用/停用约束

### 4. 新增/修改约束

表单字段说明：

#### 源单元信息
- **源单元名称**：参数所在单元名称（支持通配符 *）
- **源单元类型**：单元类型（编码/调制/解调/译码，支持通配符 *）
- **源参数名称**：参数代码（如：ENC_CODE_TYPE）

#### 目标单元信息
- **目标单元名称**：被约束参数所在单元名称（支持通配符 *）
- **目标单元类型**：单元类型（支持通配符 *）
- **目标参数名称**：被约束的参数代码（如：ENC_CODE_RATE）

#### 约束信息
- **约束类型**：选择约束类型
- **约束条件**：触发条件（如：==CONV 表示当源参数等于CONV时）
- **约束值**：约束的具体值（如：0.5,0.8 表示范围）
- **优先级**：0-100，数字越大优先级越高
- **错误提示**：验证失败时显示的错误信息
- **状态**：正常/停用
- **备注**：约束说明

## 四、使用示例

### 示例1：添加通用约束

**需求**：所有编码单元的卷积码码率范围为 0.33~0.75

**配置**：
- 源单元名称：`*`（通配符，表示所有单元）
- 源单元类型：`ENCODE`
- 源参数名称：`ENC_CODE_TYPE`
- 目标单元名称：`*`
- 目标单元类型：`ENCODE`
- 目标参数名称：`ENC_CODE_RATE`
- 约束类型：`值范围约束`
- 约束条件：`==CONV`
- 约束值：`0.33,0.75`
- 优先级：`10`
- 错误提示：`卷积码的码率范围应为0.33~0.75`

### 示例2：添加特定单元约束

**需求**：返向中低速数传的卷积码码率范围为 0.5~0.8（优先级高于通用约束）

**配置**：
- 源单元名称：`返向中低速数传`
- 源单元类型：`ENCODE`
- 源参数名称：`ENC_CODE_TYPE`
- 目标单元名称：`返向中低速数传`
- 目标单元类型：`ENCODE`
- 目标参数名称：`ENC_CODE_RATE`
- 约束类型：`值范围约束`
- 约束条件：`==CONV`
- 约束值：`0.5,0.8`
- 优先级：`15`（高于通用约束的10）
- 错误提示：`返向中低速数传卷积码的码率范围应为0.5~0.8`

### 示例3：添加启用/禁用约束

**需求**：当ACM启用时，禁用手动设置码率

**配置**：
- 源单元名称：`ACM数传`
- 源单元类型：`ENCODE`
- 源参数名称：`ACM_ENABLE`
- 目标单元名称：`ACM数传`
- 目标单元类型：`ENCODE`
- 目标参数名称：`ENC_CODE_RATE`
- 约束类型：`启用/禁用约束`
- 约束条件：`==1`（当ACM启用时）
- 约束值：（留空）
- 优先级：`20`（强制约束）
- 错误提示：`ACM启用时不能手动设置码率`

### 示例4：添加值同步约束

**需求**：编码单元和调制单元的ACM状态必须一致

**配置**：
- 源单元名称：`ACM数传`
- 源单元类型：`ENCODE`
- 源参数名称：`ACM_ENABLE`
- 目标单元名称：`ACM数传`
- 目标单元类型：`MODULATE`
- 目标参数名称：`ACM_ENABLE`
- 约束类型：`值同步约束`
- 约束条件：（留空）
- 约束值：（留空）
- 优先级：`20`
- 错误提示：`编码和调制的ACM状态必须一致`

## 五、约束验证流程

当用户在参数配置界面修改参数时：

```
用户修改参数
    ↓
防抖等待 500ms
    ↓
前端调用验证接口
    ↓
后端查询相关约束规则
    ↓
按优先级验证每个约束
    ↓
验证通过？
    ├─ 是 → 保存参数 → 显示"已保存"
    └─ 否 → 显示错误信息 → 不保存
```

## 六、优先级说明

- **20+**：强制约束（如ACM联动、环回联动）
- **10-19**：重要约束（如编码方式影响码率范围）
- **1-9**：一般约束（如推荐的参数范围）
- **0**：提示性约束（不阻止保存，仅提示）

**匹配优先级**：
1. 精确匹配（单元名称 + 单元类型）- 优先级最高
2. 单元名称通配（* + 单元类型）
3. 单元类型通配（单元名称 + *）
4. 全通配（* + *）- 优先级最低

## 七、通配符使用

使用 `*` 表示适用于所有单元：

- `source_unit_name = '*'` - 适用于所有单元名称
- `source_unit_type = '*'` - 适用于所有单元类型
- 两者都是 `*` - 适用于所有单元

**示例**：
```
源单元名称: *
源单元类型: ENCODE
→ 适用于所有编码单元

源单元名称: 返向中低速数传
源单元类型: *
→ 适用于"返向中低速数传"的所有单元类型
```

## 八、常见问题

### Q1：修改参数时提示"Unknown column 'source_param_name'"

**A**：数据库表结构未更新，请执行步骤1的修复SQL。

### Q2：菜单中看不到"参数约束"选项

**A**：
1. 检查是否执行了步骤2的菜单添加SQL
2. 刷新浏览器（Ctrl+F5）
3. 重新登录系统
4. 检查用户是否有相应权限

### Q3：约束不生效

**A**：
1. 检查约束状态是否为"正常"（不是"停用"）
2. 检查参数名称是否正确（区分大小写）
3. 检查约束条件和约束值是否正确
4. 查看后端日志，确认约束是否被查询到

### Q4：如何删除所有约束重新开始

**A**：
```sql
TRUNCATE TABLE sys_baseband_param_constraint;
```

### Q5：如何导出约束规则

**A**：
```sql
SELECT * FROM sys_baseband_param_constraint 
WHERE status = '0' 
ORDER BY priority DESC;
```

## 九、文件清单

### SQL文件
- `fix_param_constraint_table.sql` - 修复表结构
- `add_constraint_menu.sql` - 添加菜单
- `insert_param_constraints_by_unit_name.sql` - 详细约束数据（可选）

### 批处理脚本
- `fix_database.bat` - 修复表结构脚本
- `add_constraint_menu.bat` - 添加菜单脚本

### 前端文件
- `RuoYi-Vue3/src/views/system/baseband/paramConstraint/index.vue` - 约束管理界面
- `RuoYi-Vue3/src/api/system/baseband/paramConstraint.js` - API接口
- `RuoYi-Vue3/src/views/system/baseband/paramValue/index.vue` - 参数配置界面（已集成验证）

### 后端文件
- `SysBasebandParamConstraint.java` - 实体类
- `SysBasebandParamConstraintMapper.java` - Mapper接口
- `SysBasebandParamConstraintMapper.xml` - SQL映射
- `ISysBasebandParamConstraintService.java` - Service接口
- `SysBasebandParamConstraintServiceImpl.java` - Service实现
- `SysBasebandParamConstraintController.java` - Controller

### 文档文件
- `基带参数约束关系详细设计.md` - 设计文档
- `参数约束关系功能实现说明.md` - 后端实现说明
- `参数约束关系前端实现说明.md` - 前端实现说明
- `参数约束表修复说明.md` - 表修复说明
- `参数约束功能部署指南.md` - 本文档

## 十、技术支持

如有问题，请检查：
1. 后端日志：查看约束验证的详细信息
2. 浏览器控制台：查看前端错误信息
3. 数据库日志：查看SQL执行情况

## 十一、下一步

部署完成后，你可以：
1. 在约束管理界面添加更多约束规则
2. 测试参数配置时的约束验证
3. 根据实际需求调整约束优先级
4. 导入详细的约束数据（`insert_param_constraints_by_unit_name.sql`）
