# 参数定义排序自动刷新测试指南

## 功能说明

当在参数定义页面拖拽调整参数顺序后，已打开的基带单元参数配置页面会自动刷新，显示最新的参数顺序，无需手动刷新或重新打开。

## 测试步骤

### 准备工作
1. 确保后端服务已启动
2. 确保前端服务已启动
3. 使用管理员账号登录系统

### 测试场景1：单个配置页面自动刷新

#### 步骤：
1. 打开"基带单元管理"页面
2. 选择一个基带单元（如ENCODE类型），点击"参数配置"按钮
3. 参数配置页面会在新标签页打开，记住当前参数的顺序
4. **不要关闭参数配置页面**，切换到"基带参数定义"页面
5. 在参数定义页面，筛选相同的单元类型（ENCODE）
6. 拖拽某个参数到不同位置（例如将第3个参数拖到第1个位置）
7. 系统提示"排序已更新"
8. 切换回参数配置页面的标签页

#### 预期结果：
- 参数配置页面自动刷新
- 显示提示消息"参数列表已更新"
- 参数顺序与参数定义页面一致
- 无需手动刷新页面

### 测试场景2：多个配置页面同时刷新

#### 步骤：
1. 打开多个不同单元的参数配置页面（例如：ENCODE单元1、ENCODE单元2、MODULATE单元1）
2. 切换到"基带参数定义"页面
3. 筛选ENCODE类型
4. 拖拽调整ENCODE类型参数的顺序
5. 系统提示"排序已更新"
6. 依次切换到各个参数配置页面

#### 预期结果：
- 所有ENCODE类型的参数配置页面都自动刷新
- MODULATE类型的参数配置页面不受影响（因为修改的是ENCODE类型）
- 每个刷新的页面都显示"参数列表已更新"提示

### 测试场景3：跨单元类型验证

#### 步骤：
1. 打开一个ENCODE单元的参数配置页面
2. 打开一个MODULATE单元的参数配置页面
3. 在参数定义页面修改MODULATE类型参数的顺序
4. 观察两个配置页面的变化

#### 预期结果：
- MODULATE单元的配置页面自动刷新
- ENCODE单元的配置页面不刷新（因为修改的是MODULATE类型）
- 只有相关单元类型的页面会刷新

### 测试场景4：无筛选条件下的排序

#### 步骤：
1. 打开多个不同类型单元的参数配置页面
2. 在参数定义页面，**不筛选单元类型**（显示所有参数）
3. 拖拽调整某个参数的顺序
4. 观察所有配置页面

#### 预期结果：
- 所有打开的参数配置页面都会刷新
- 因为修改影响了所有单元类型

## 验证要点

### 1. 自动刷新时机
- ✅ 排序保存成功后立即触发
- ✅ 延迟300ms后执行刷新（确保后端数据已更新）
- ✅ 只刷新相关单元类型的页面

### 2. 用户体验
- ✅ 显示明确的提示消息
- ✅ 刷新过程流畅，无明显卡顿
- ✅ 保持用户当前的滚动位置和视图模式

### 3. 数据一致性
- ✅ 刷新后的参数顺序与参数定义一致
- ✅ 参数值不丢失
- ✅ 约束规则正确应用

### 4. 边界情况
- ✅ 配置页面未打开时，不会有任何影响
- ✅ 网络延迟时，刷新仍能正常工作
- ✅ 多次快速拖拽时，只触发最后一次刷新

## 常见问题排查

### 问题1：配置页面没有自动刷新
**可能原因**：
- Store未正确导入
- 监听器未正确设置
- 单元类型不匹配

**排查方法**：
1. 打开浏览器控制台
2. 查看是否有日志输出：`[Baseband Store] 参数定义已更新`
3. 查看是否有日志输出：`[参数配置] 检测到参数定义更新`
4. 检查单元类型是否匹配

### 问题2：刷新后参数顺序不正确
**可能原因**：
- 后端排序逻辑错误
- 数据库未正确更新
- 缓存问题

**排查方法**：
1. 检查数据库中的 `sort_order` 字段值
2. 查看后端日志，确认更新SQL执行成功
3. 清除浏览器缓存后重试

### 问题3：提示消息重复显示
**可能原因**：
- 监听器触发多次
- Store状态未正确重置

**排查方法**：
1. 检查 `watch` 的条件判断
2. 确认 `newTime !== oldTime` 条件生效
3. 查看控制台日志，统计触发次数

## 技术实现要点

### 1. Pinia Store
- 使用 `defineStore` 创建全局状态管理
- `paramDefUpdateTime` 作为触发器，使用时间戳确保唯一性
- `paramDefUpdateUnitType` 用于精确控制刷新范围

### 2. Watch 监听
- 监听 Store 的 `paramDefUpdateTime` 变化
- 使用条件判断避免重复触发
- 延迟300ms执行，确保后端数据已更新

### 3. 单元类型匹配
- 只刷新相关单元类型的配置页面
- 提高性能，避免不必要的刷新
- 如果未指定单元类型，则刷新所有页面

## 性能考虑

1. **延迟刷新**：使用300ms延迟，避免频繁请求
2. **条件刷新**：只刷新相关单元类型的页面
3. **单次触发**：使用时间戳确保每次更新只触发一次

## 后续优化建议

1. **批量操作优化**：如果短时间内多次拖拽，可以合并刷新请求
2. **加载状态**：刷新时显示加载动画，提升用户体验
3. **错误处理**：刷新失败时提供重试机制
4. **离线支持**：网络断开时缓存更新，恢复后自动同步

## 更新日期

2025-12-03
