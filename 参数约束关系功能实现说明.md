# 参数约束关系功能实现说明

## 一、功能概述

基于之前设计的三维约束模型（单元名称 → 单元类型 → 参数 → 约束关系），已完成后端核心功能的实现。

## 二、已实现的功能

### 1. 数据库层

**表结构**：`sys_baseband_param_constraint`
- 支持单元名称、单元类型、参数名称的三维约束
- 支持通配符（*）实现通用规则
- 支持优先级排序
- SQL文件位置：
  - `RuoYi-Vue/sql/create_param_constraint_table.sql` - 表结构
  - `RuoYi-Vue/sql/insert_param_constraints_by_unit_name.sql` - 示例数据

### 2. 后端实现

#### 实体类
- `SysBasebandParamConstraint.java` - 约束关系实体

#### Mapper层
- `SysBasebandParamConstraintMapper.java` - 接口
- `SysBasebandParamConstraintMapper.xml` - SQL映射
- 核心查询方法：
  - `selectConstraintsBySourceParam()` - 根据源参数查询约束
  - `selectConstraintsByTargetParam()` - 根据目标参数查询约束
  - 支持单元名称和单元类型的精确匹配和通配符匹配

#### Service层
- `ISysBasebandParamConstraintService.java` - 服务接口
- `SysBasebandParamConstraintServiceImpl.java` - 服务实现

**核心功能**：

1. **约束验证** (`validateParamConstraint`)
   - 支持4种约束类型：
     - `VALUE_RANGE` - 值范围约束
     - `ENABLE_DISABLE` - 启用/禁用约束
     - `VALUE_SYNC` - 值同步约束
     - `VALUE_CALCULATE` - 值计算约束

2. **条件表达式评估** (`evaluateCondition`)
   - 支持比较运算符：`==`, `!=`, `>`, `<`, `>=`, `<=`
   - 支持数值和字符串比较

3. **受影响参数查询** (`getAffectedParams`)
   - 查询某个参数变化时会影响哪些其他参数

#### Controller层
- `SysBasebandParamConstraintController.java`
- 提供RESTful API：
  - `GET /system/paramConstraint/list` - 查询约束列表
  - `POST /system/paramConstraint/validate` - 验证参数约束
  - `GET /system/paramConstraint/affected/{unitName}/{unitType}/{paramName}` - 获取受影响参数
  - `POST /system/paramConstraint` - 新增约束
  - `PUT /system/paramConstraint` - 修改约束
  - `DELETE /system/paramConstraint/{constraintIds}` - 删除约束

### 3. 集成到参数保存流程

已修改 `SysBasebandParamValueServiceImpl.saveParamValues()` 方法：
- 在保存参数前自动验证所有约束
- 如果验证失败，抛出异常并回滚事务
- 验证通过后才保存参数值

## 三、使用示例

### 1. 数据库初始化

```sql
-- 1. 创建表结构
source RuoYi-Vue/sql/create_param_constraint_table.sql

-- 2. 导入示例约束数据
source RuoYi-Vue/sql/insert_param_constraints_by_unit_name.sql
```

### 2. API调用示例

#### 验证参数约束
```javascript
POST /system/paramConstraint/validate
{
  "unitName": "返向中低速数传",
  "unitType": "编码单元",
  "paramName": "code_rate",
  "paramValue": "0.5",
  "allParams": {
    "code_type": "CONV",
    "code_rate": "0.5",
    "modulation_type": "BPSK"
  }
}
```

#### 查询受影响的参数
```javascript
GET /system/paramConstraint/affected/返向中低速数传/编码单元/code_type
```

返回：
```json
[
  {
    "constraintId": 1,
    "sourceParamName": "code_type",
    "targetParamName": "code_rate",
    "constraintType": "VALUE_RANGE",
    "constraintValue": "0.5,0.8"
  }
]
```

### 3. 约束验证流程

当用户保存参数配置时：

1. 前端调用 `POST /system/paramValue/save`
2. 后端 `saveParamValues()` 方法：
   - 收集所有参数值
   - 逐个验证每个参数的约束
   - 如果有约束失败，抛出异常并返回错误信息
   - 验证通过后保存到数据库

## 四、约束类型说明

### 1. VALUE_RANGE - 值范围约束

**示例**：当编码方式为卷积码时，码率范围为0.5~0.8

```sql
INSERT INTO sys_baseband_param_constraint VALUES (
  1, '返向中低速数传', '编码单元', 'code_type', 
  '返向中低速数传', '编码单元', 'code_rate',
  'VALUE_RANGE', '==CONV', '0.5,0.8', 
  10, '卷积码的码率范围应为0.5~0.8', '0', ...
);
```

### 2. ENABLE_DISABLE - 启用/禁用约束

**示例**：当ACM启用时，禁用手动设置码率

```sql
INSERT INTO sys_baseband_param_constraint VALUES (
  2, 'ACM数传', '编码单元', 'acm_enable', 
  'ACM数传', '编码单元', 'code_rate',
  'ENABLE_DISABLE', '==1', '', 
  20, 'ACM启用时不能手动设置码率', '0', ...
);
```

### 3. VALUE_SYNC - 值同步约束

**示例**：编码单元和调制单元的ACM状态必须一致

```sql
INSERT INTO sys_baseband_param_constraint VALUES (
  3, 'ACM数传', '编码单元', 'acm_enable', 
  'ACM数传', '调制单元', 'acm_enable',
  'VALUE_SYNC', '', '', 
  20, '编码和调制的ACM状态必须一致', '0', ...
);
```

### 4. VALUE_CALCULATE - 值计算约束

**示例**：符号率 = 数据率 / log2(调制阶数)

```sql
INSERT INTO sys_baseband_param_constraint VALUES (
  4, '返向高速数传', '调制单元', 'data_rate', 
  '返向高速数传', '调制单元', 'symbol_rate',
  'VALUE_CALCULATE', '', 'data_rate/log2(mod_order)', 
  5, '符号率应等于数据率除以调制阶数的对数', '0', ...
);
```

## 五、优先级说明

- **20+**：强制约束（如ACM联动、环回联动）
- **10-19**：重要约束（如编码方式影响码率范围）
- **1-9**：一般约束（如推荐的参数范围）
- **0**：提示性约束（不阻止保存，仅提示）

## 六、通配符支持

使用 `*` 表示适用于所有单元名称或单元类型：

```sql
-- 适用于所有单元名称的"编码单元"
source_unit_name = '*'
source_unit_type = '编码单元'

-- 适用于所有类型的约束
source_unit_name = '*'
source_unit_type = '*'
```

查询时按优先级排序：
1. 精确匹配（单元名称 + 单元类型）
2. 单元名称通配（* + 单元类型）
3. 单元类型通配（单元名称 + *）
4. 全通配（* + *）

## 七、下一步工作

### 前端集成（待实现）

1. **参数配置界面增强**
   - 实时约束验证
   - 参数联动提示
   - 错误信息显示

2. **约束管理界面**
   - 约束规则的增删改查
   - 约束测试工具

3. **智能提示**
   - 参数变化时提示受影响的参数
   - 显示可选值范围
   - 自动禁用/启用相关参数

### 功能扩展

1. **跨单元约束**
   - 支持不同单元之间的参数约束
   - 例如：编码单元的输出速率 = 调制单元的输入速率

2. **复杂计算约束**
   - 支持更复杂的表达式计算
   - 引入表达式引擎（如MVEL、SpEL）

3. **约束模板**
   - 预定义常用约束模板
   - 快速应用到新单元

## 八、测试建议

1. **单元测试**
   - 测试各种约束类型的验证逻辑
   - 测试边界条件
   - 测试通配符匹配

2. **集成测试**
   - 测试参数保存流程
   - 测试约束验证失败的回滚
   - 测试跨参数约束

3. **性能测试**
   - 测试大量约束规则的查询性能
   - 测试批量参数验证的性能

## 九、注意事项

1. **约束数据的维护**
   - 约束规则应该由系统管理员或专业人员维护
   - 建议提供约束规则的导入导出功能

2. **错误信息的友好性**
   - 错误信息应该清晰明确
   - 提供修改建议

3. **性能优化**
   - 约束查询使用索引
   - 考虑缓存常用约束规则

4. **向后兼容**
   - 新增约束不应影响现有功能
   - 可以通过status字段临时禁用约束

## 十、文件清单

### 后端文件
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/domain/SysBasebandParamConstraint.java`
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/mapper/SysBasebandParamConstraintMapper.java`
- `RuoYi-Vue/ruoyi-system/src/main/resources/mapper/system/SysBasebandParamConstraintMapper.xml`
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/service/ISysBasebandParamConstraintService.java`
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysBasebandParamConstraintServiceImpl.java`
- `RuoYi-Vue/ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SysBasebandParamConstraintController.java`
- `RuoYi-Vue/ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysBasebandParamValueServiceImpl.java` (已修改)

### 数据库文件
- `RuoYi-Vue/sql/create_param_constraint_table.sql`
- `RuoYi-Vue/sql/insert_param_constraints_by_unit_name.sql`

### 文档文件
- `基带参数约束关系详细设计.md`
- `参数约束关系实现方案.md`
- `参数约束关系功能实现说明.md` (本文档)
