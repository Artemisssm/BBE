# 基带监控 - 宏管理功能设计文档

## 📋 功能概述

宏管理模块允许用户预先配置参数模板，在创建基带单元时自动应用这些参数配置并下发到硬件，大幅提升配置效率。

## 🎯 核心功能

### 1. 宏模板管理
- **创建宏**：定义宏名称、适用单元类型、模式类型
- **编辑宏**：修改宏的基本信息和参数配置
- **删除宏**：删除不需要的宏模板
- **启用/停用**：控制宏的可用状态
- **设置默认宏**：为每种单元类型设置默认宏

### 2. 参数配置
- **参数选择**：从参数定义中选择需要配置的参数
- **参数赋值**：为每个参数设置默认值
- **批量配置**：一次性配置多个参数
- **参数验证**：确保参数值符合定义的约束

### 3. 宏应用
- **创建单元时选择宏**：在新增单元对话框中选择要应用的宏
- **自动应用默认宏**：如果设置了默认宏，自动选中
- **参数自动下发**：单元创建成功后，自动将宏参数下发到硬件
- **下发状态反馈**：显示参数下发的成功/失败状态

## 📊 数据库设计

### 表1：sys_baseband_macro（宏定义表）
| 字段 | 类型 | 说明 |
|------|------|------|
| macro_id | BIGINT | 宏ID（主键） |
| macro_name | VARCHAR(64) | 宏名称 |
| macro_code | VARCHAR(64) | 宏编码（唯一） |
| unit_type | VARCHAR(16) | 适用单元类型 |
| mode_type | VARCHAR(32) | 适用模式类型 |
| description | VARCHAR(255) | 宏描述 |
| is_default | CHAR(1) | 是否默认宏 |
| status | CHAR(1) | 状态 |
| sort_order | INT | 排序 |

### 表2：sys_baseband_macro_param（宏参数值表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| macro_id | BIGINT | 宏ID |
| param_id | BIGINT | 参数定义ID |
| param_value | VARCHAR(64) | 参数值 |

## 🎨 界面设计

### 宏管理主页面
```
┌─────────────────────────────────────────────────────────┐
│ 🔍 搜索栏                                                │
│  宏名称: [_______]  单元类型: [▼]  状态: [▼]  [搜索] [重置] │
├─────────────────────────────────────────────────────────┤
│ [➕新增] [✏️修改] [🗑️删除] [📤导出]                        │
├─────────────────────────────────────────────────────────┤
│ 宏列表表格                                               │
│ ┌──┬────────┬──────┬──────┬──────┬────┬────┬────────┐  │
│ │☑│宏名称   │单元类型│模式类型│参数数│默认│状态│操作    │  │
│ ├──┼────────┼──────┼──────┼──────┼────┼────┼────────┤  │
│ │☐│编码标准 │编码   │KSA   │15个  │是  │正常│[配置参数]│  │
│ │☐│编码高速 │编码   │KMA   │18个  │否  │正常│[配置参数]│  │
│ │☐│调制标准 │调制   │KSA   │12个  │是  │正常│[配置参数]│  │
│ └──┴────────┴──────┴──────┴──────┴────┴────┴────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 宏参数配置对话框
```
┌─────────────────────────────────────────────────────────┐
│ 配置宏参数 - 编码标准配置                                 │
├─────────────────────────────────────────────────────────┤
│ 基本信息：                                               │
│  宏名称：编码标准配置                                     │
│  单元类型：编码    模式类型：KSA                          │
├─────────────────────────────────────────────────────────┤
│ 参数配置：                                               │
│ ┌──────────┬──────────┬──────────┬──────────┬────────┐ │
│ │参数名称   │参数类型   │取值范围   │当前值     │操作    │ │
│ ├──────────┼──────────┼──────────┼──────────┼────────┤ │
│ │码率       │UINT      │1-1000    │[100____] │[删除]  │ │
│ │编码方式   │ENUM      │LDPC/Turbo│[LDPC▼]   │[删除]  │ │
│ │帧长       │UINT      │64-8192   │[1024___] │[删除]  │ │
│ └──────────┴──────────┴──────────┴──────────┴────────┘ │
│                                                          │
│ [➕添加参数]                                              │
├─────────────────────────────────────────────────────────┤
│                              [确定] [取消]                │
└─────────────────────────────────────────────────────────┘
```

### 创建单元时选择宏
```
┌─────────────────────────────────────────────────────────┐
│ 新增基带单元                                             │
├─────────────────────────────────────────────────────────┤
│ 链路模式: [返向中低速数传 ▼]                             │
│ 单元类型: ☑编码 ☐调制 ☐解调 ☐译码                       │
│ 模式类型: [KSA ▼]                                        │
│ 板卡资源: [板1-FPGA0 ▼]                                  │
│                                                          │
│ ⭐ 应用宏配置:                                            │
│  [编码标准配置 ▼]  ℹ️ 将自动应用15个预设参数              │
│  ☑ 创建后立即下发参数到硬件                               │
│                                                          │
│ 版本: [v1.0_____]                                        │
│ 备注: [___________]                                      │
├─────────────────────────────────────────────────────────┤
│                              [确定] [取消]                │
└─────────────────────────────────────────────────────────┘
```

## 🔄 业务流程

### 流程1：创建宏模板
```
1. 用户点击"新增"按钮
2. 填写宏基本信息（名称、单元类型、模式类型等）
3. 保存宏定义
4. 点击"配置参数"按钮
5. 选择要配置的参数
6. 为每个参数设置默认值
7. 保存参数配置
```

### 流程2：应用宏创建单元
```
1. 用户在基带单元页面点击"新增"
2. 填写基本信息（链路模式、单元类型等）
3. 系统根据单元类型和模式类型，自动加载可用的宏列表
4. 用户选择要应用的宏（或使用默认宏）
5. 勾选"创建后立即下发参数"
6. 点击"确定"创建单元
7. 系统执行：
   a. 创建基带单元记录
   b. 从宏中读取参数配置
   c. 批量插入参数值到 sys_baseband_param_value
   d. 调用下发接口，将参数发送到硬件
   e. 记录下发日志
8. 显示创建和下发结果
```

### 流程3：参数下发详细流程
```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│创建单元   │───>│应用宏参数 │───>│下发到硬件 │───>│记录日志   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │                │               │
     │               │                │               │
     ▼               ▼                ▼               ▼
  插入单元表      插入参数值表      组播发送        插入日志表
```

## 💻 技术实现

### 后端接口

#### 1. 宏管理接口
```java
// 查询宏列表
GET /system/basebandMacro/list

// 获取宏详情
GET /system/basebandMacro/{macroId}

// 新增宏
POST /system/basebandMacro

// 修改宏
PUT /system/basebandMacro

// 删除宏
DELETE /system/basebandMacro/{macroIds}

// 获取宏的参数配置
GET /system/basebandMacro/{macroId}/params

// 保存宏的参数配置
POST /system/basebandMacro/{macroId}/params

// 根据单元类型和模式类型获取可用宏
GET /system/basebandMacro/available?unitType=ENCODE&modeType=KSA
```

#### 2. 单元创建增强接口
```java
// 创建单元并应用宏
POST /system/basebandUnit/createWithMacro
{
  "unitName": "返向中低速数传",
  "unitType": "ENCODE",
  "channelNo": 1,
  "modeType": "KSA",
  "macroId": 1,              // 要应用的宏ID
  "autoDispatch": true       // 是否自动下发
}
```

### 前端组件

#### 1. 宏管理页面
- `RuoYi-Vue3/src/views/system/baseband/macro/index.vue`
- 功能：宏列表、增删改查、参数配置

#### 2. 宏参数配置对话框
- `RuoYi-Vue3/src/views/system/baseband/macro/components/MacroParamConfig.vue`
- 功能：配置宏的参数值

#### 3. 基带单元创建增强
- 修改 `RuoYi-Vue3/src/views/system/baseband/unit/index.vue`
- 添加宏选择下拉框
- 添加自动下发选项

## 🎯 核心优势

### 1. 提升效率
- **快速配置**：一键应用预设参数，无需逐个配置
- **批量创建**：创建多个相同配置的单元时，使用同一个宏
- **减少错误**：预设的参数值经过验证，避免配置错误

### 2. 标准化管理
- **配置模板化**：将常用配置固化为模板
- **版本管理**：不同版本的配置可以创建不同的宏
- **团队协作**：团队成员共享标准配置

### 3. 自动化下发
- **即创即用**：单元创建后立即可用
- **减少操作**：无需手动进入参数配置页面
- **状态追踪**：下发日志记录完整的操作历史

## 📝 使用场景

### 场景1：快速部署标准配置
```
需求：创建10个编码单元，都使用标准KSA配置
步骤：
1. 创建"编码KSA标准"宏，配置好所有参数
2. 批量创建10个单元，都选择这个宏
3. 系统自动应用参数并下发
结果：10个单元快速部署完成，配置一致
```

### 场景2：测试不同配置方案
```
需求：测试高速和低速两种编码配置的性能
步骤：
1. 创建"编码高速"和"编码低速"两个宏
2. 分别配置不同的码率、帧长等参数
3. 创建单元时切换不同的宏
结果：快速切换配置方案，便于对比测试
```

### 场景3：版本升级
```
需求：硬件升级后，参数配置有变化
步骤：
1. 创建新版本的宏（如"编码标准v2.0"）
2. 配置新版本的参数值
3. 新创建的单元使用新宏
结果：新旧版本配置并存，平滑过渡
```

## ⚠️ 注意事项

1. **参数兼容性**：宏中配置的参数必须与单元类型匹配
2. **默认宏唯一性**：每种单元类型+模式类型组合只能有一个默认宏
3. **宏删除限制**：如果宏正在被使用，需要提示用户
4. **下发失败处理**：如果参数下发失败，需要记录日志并提示用户
5. **参数验证**：应用宏时需要验证参数值是否符合约束条件

## 🚀 后续扩展

1. **宏导入导出**：支持导出宏配置为JSON文件，便于备份和分享
2. **宏版本管理**：支持宏的版本控制，可以回退到历史版本
3. **宏复制功能**：基于现有宏快速创建新宏
4. **宏应用统计**：统计每个宏的使用次数和成功率
5. **智能推荐**：根据单元类型和历史使用情况，推荐合适的宏

## 📊 实施计划

### 第一阶段：基础功能（核心）
- ✅ 数据库表设计
- ✅ 后端实体类和Mapper
- ⏳ 宏管理CRUD接口
- ⏳ 宏参数配置接口
- ⏳ 前端宏管理页面
- ⏳ 前端宏参数配置对话框

### 第二阶段：集成应用
- ⏳ 修改单元创建接口，支持宏应用
- ⏳ 修改单元创建页面，添加宏选择
- ⏳ 实现自动参数下发逻辑
- ⏳ 下发状态反馈

### 第三阶段：优化完善
- ⏳ 默认宏自动选中
- ⏳ 参数验证增强
- ⏳ 错误处理和日志
- ⏳ 用户体验优化

---

**文档版本**：v1.0  
**创建日期**：2025-12-09  
**最后更新**：2025-12-09
