# 参数约束关系前端实现说明

## 一、功能概述

在参数配置界面集成了约束验证功能，实现参数修改时的实时验证和智能提示。

## 二、已实现的功能

### 1. API接口层

**文件**：`RuoYi-Vue3/src/api/system/baseband/paramConstraint.js`

提供的接口：
- `listParamConstraint(query)` - 查询约束列表
- `getParamConstraint(constraintId)` - 查询约束详情
- `addParamConstraint(data)` - 新增约束
- `updateParamConstraint(data)` - 修改约束
- `delParamConstraint(constraintIds)` - 删除约束
- `validateParamConstraint(data)` - 验证参数约束
- `getAffectedParams(unitName, unitType, paramName)` - 获取受影响参数

### 2. 参数配置界面增强

**文件**：`RuoYi-Vue3/src/views/system/baseband/paramValue/index.vue`

#### 核心功能

1. **实时约束验证**
   - 参数值变化时自动触发验证
   - 使用防抖机制（500ms）避免频繁请求
   - 验证流程：参数变化 → 防抖等待 → 约束验证 → 保存参数

2. **验证状态提示**
   - 验证中：显示"验证中..."状态
   - 保存中：显示"保存中..."状态
   - 成功：显示"已保存"状态（3秒后自动隐藏）
   - 失败：显示"验证失败"或"保存失败"（5秒后隐藏）

3. **约束提示信息**
   - 在参数卡片底部显示约束提示
   - 在列表视图中增加"约束提示"列
   - 使用黄色背景突出显示约束信息

#### 实现细节

```javascript
// 参数变化处理
function handleParamChange(param) {
  // 清除之前的定时器
  if (autoSaveTimer) {
    clearTimeout(autoSaveTimer)
  }
  
  // 显示验证中状态
  autoSaveStatus.value = {
    type: 'saving',
    text: '验证中...'
  }
  
  // 防抖：500ms后验证并保存
  autoSaveTimer = setTimeout(() => {
    validateAndSaveParam(param)
  }, 500)
}

// 验证并保存参数
async function validateAndSaveParam(param) {
  try {
    // 构建所有参数的Map
    const allParamsMap = {}
    paramList.value.forEach(p => {
      allParamsMap[p.paramCode] = p.rawValue ? String(p.rawValue) : ''
    })
    
    // 验证约束
    const validateData = {
      unitName: unitInfo.value.unitName,
      unitType: unitInfo.value.unitType,
      paramName: param.paramCode,
      paramValue: param.rawValue ? String(param.rawValue) : '',
      allParams: allParamsMap
    }
    
    await validateParamConstraint(validateData)
    
    // 验证通过，保存参数
    await autoSaveParam(param)
    
  } catch (error) {
    // 验证失败，显示错误信息
    autoSaveStatus.value = {
      type: 'error',
      text: '验证失败'
    }
    
    const errorMsg = error.msg || error.message || '参数约束验证失败'
    proxy.$modal.msgError(errorMsg)
  }
}
```

### 3. 约束管理界面

**文件**：`RuoYi-Vue3/src/views/system/baseband/paramConstraint/index.vue`

#### 功能特性

1. **约束列表展示**
   - 显示源单元、源参数、目标单元、目标参数
   - 显示约束类型、条件、值、优先级
   - 支持状态切换（启用/停用）

2. **搜索和筛选**
   - 按源单元名称搜索
   - 按源单元类型筛选
   - 按约束类型筛选
   - 按状态筛选

3. **约束管理**
   - 新增约束规则
   - 修改约束规则
   - 删除约束规则
   - 批量删除

4. **通配符支持**
   - 单元名称和单元类型支持通配符（*）
   - 实现通用约束规则

## 三、使用流程

### 1. 参数配置流程

```
用户修改参数值
    ↓
触发 handleParamChange
    ↓
防抖等待 500ms
    ↓
调用 validateAndSaveParam
    ↓
构建验证数据（包含所有参数）
    ↓
调用后端验证接口
    ↓
验证通过？
    ├─ 是 → 保存参数 → 显示"已保存"
    └─ 否 → 显示错误信息 → 不保存
```

### 2. 约束验证数据结构

```javascript
{
  "unitName": "返向中低速数传",
  "unitType": "ENCODE",
  "paramName": "code_rate",
  "paramValue": "0.5",
  "allParams": {
    "code_type": "CONV",
    "code_rate": "0.5",
    "modulation_type": "BPSK",
    "symbol_rate": "10"
  }
}
```

### 3. 验证响应

**成功**：
```json
{
  "code": 200,
  "msg": "操作成功"
}
```

**失败**：
```json
{
  "code": 500,
  "msg": "卷积码的码率范围应为0.5~0.8"
}
```

## 四、界面展示

### 1. 参数配置界面

#### 网格视图
- 参数卡片显示参数名称、类型、控件
- 底部显示默认值、范围、约束提示
- 约束提示使用黄色背景突出显示

#### 列表视图
- 表格形式展示所有参数
- 增加"约束提示"列
- 约束提示带图标，易于识别

#### 自动保存状态
- 右上角显示保存状态
- 验证中：蓝色旋转图标
- 成功：绿色对勾图标
- 失败：红色叉号图标

### 2. 约束管理界面

#### 列表展示
- 源单元和目标单元分别显示
- 约束类型使用不同颜色标签
- 优先级数字显示
- 状态开关可直接切换

#### 编辑表单
- 分组显示源单元、目标单元、约束信息
- 支持通配符选择
- 约束类型下拉选择
- 优先级数字输入

## 五、样式设计

### 1. 约束提示样式

```css
.param-constraint-hint {
  display: flex;
  align-items: flex-start;
  gap: 4px;
  padding: 6px 8px;
  background: #fff3cd;  /* 黄色背景 */
  border-radius: 4px;
  margin-top: 4px;
}

.param-constraint-hint .hint-icon {
  color: #856404;  /* 深黄色图标 */
  font-size: 14px;
}

.param-constraint-hint .hint-text {
  color: #856404;  /* 深黄色文字 */
  font-size: 11px;
  line-height: 1.4;
}
```

### 2. 自动保存状态样式

```css
.auto-save-status {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  backdrop-filter: blur(10px);
}

.status-icon.saving {
  color: #409eff;
  animation: rotate 1s linear infinite;
}

.status-icon.success {
  color: #67c23a;
}

.status-icon.error {
  color: #f56c6c;
}
```

## 六、待实现功能

### 1. 参数联动提示

当修改某个参数时，自动提示受影响的其他参数：

```javascript
// 获取受影响的参数
async function showAffectedParams(param) {
  const affected = await getAffectedParams(
    unitInfo.value.unitName,
    unitInfo.value.unitType,
    param.paramCode
  )
  
  if (affected.length > 0) {
    // 高亮显示受影响的参数
    // 或显示提示信息
  }
}
```

### 2. 智能参数推荐

根据约束关系，自动推荐合适的参数值：

```javascript
// 根据约束计算推荐值
function getRecommendedValue(param, constraints) {
  // 分析约束条件
  // 计算推荐值范围
  // 返回推荐值
}
```

### 3. 约束冲突检测

检测多个约束之间是否存在冲突：

```javascript
// 检测约束冲突
function detectConstraintConflict(constraints) {
  // 分析约束逻辑
  // 检测是否存在矛盾
  // 返回冲突信息
}
```

### 4. 批量参数验证

在下发参数前，批量验证所有参数：

```javascript
// 批量验证
async function validateAllParams() {
  const errors = []
  
  for (const param of paramList.value) {
    const error = await validateParam(param)
    if (error) {
      errors.push({ param: param.paramName, error })
    }
  }
  
  return errors
}
```

### 5. 约束规则导入导出

支持约束规则的批量导入导出：

```javascript
// 导出约束规则
function exportConstraints() {
  // 导出为JSON或Excel
}

// 导入约束规则
function importConstraints(file) {
  // 解析文件
  // 批量创建约束
}
```

## 七、性能优化建议

### 1. 约束缓存

```javascript
// 缓存约束规则
const constraintCache = new Map()

function getCachedConstraints(unitName, unitType, paramName) {
  const key = `${unitName}-${unitType}-${paramName}`
  if (!constraintCache.has(key)) {
    // 从服务器获取并缓存
  }
  return constraintCache.get(key)
}
```

### 2. 防抖优化

```javascript
// 使用lodash的debounce
import { debounce } from 'lodash-es'

const debouncedValidate = debounce(validateAndSaveParam, 500)
```

### 3. 批量验证

```javascript
// 收集一段时间内的所有变化，批量验证
const pendingChanges = []

function batchValidate() {
  if (pendingChanges.length === 0) return
  
  // 批量验证所有变化
  validateMultipleParams(pendingChanges)
  pendingChanges.length = 0
}
```

## 八、测试建议

### 1. 单元测试

- 测试约束验证逻辑
- 测试防抖机制
- 测试错误处理

### 2. 集成测试

- 测试参数修改流程
- 测试约束验证流程
- 测试错误提示

### 3. 用户体验测试

- 测试响应速度
- 测试错误信息的清晰度
- 测试界面交互流畅性

## 九、注意事项

1. **防抖时间**：500ms是一个平衡值，可根据实际情况调整

2. **错误处理**：验证失败时不应保存参数，避免无效数据

3. **用户体验**：
   - 验证过程应该快速
   - 错误信息应该清晰
   - 状态提示应该明显

4. **性能考虑**：
   - 避免频繁的网络请求
   - 使用缓存减少服务器压力
   - 批量操作优于单个操作

5. **兼容性**：
   - 确保在不同浏览器中正常工作
   - 移动端适配

## 十、文件清单

### 前端文件
- `RuoYi-Vue3/src/api/system/baseband/paramConstraint.js` - 约束API
- `RuoYi-Vue3/src/views/system/baseband/paramValue/index.vue` - 参数配置界面（已修改）
- `RuoYi-Vue3/src/views/system/baseband/paramConstraint/index.vue` - 约束管理界面

### 后端文件（已实现）
- 实体类、Mapper、Service、Controller
- 详见《参数约束关系功能实现说明.md》

### 数据库文件
- `RuoYi-Vue/sql/create_param_constraint_table.sql`
- `RuoYi-Vue/sql/insert_param_constraints_by_unit_name.sql`

### 文档文件
- `基带参数约束关系详细设计.md` - 设计文档
- `参数约束关系实现方案.md` - 实现方案
- `参数约束关系功能实现说明.md` - 后端实现说明
- `参数约束关系前端实现说明.md` - 本文档
