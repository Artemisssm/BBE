# 板卡资源实时刷新功能说明

## 🎯 功能概述

实现了板卡资源监控页面的实时自动刷新功能，当基带单元发生变化时，板卡资源页面会立即更新，无需手动刷新。

## ✨ 核心特性

### 1. 事件驱动刷新
当在"基带单元"页面进行以下操作时，"板卡资源"页面会自动刷新：
- ✅ **新增单元** - 立即显示新的资源占用情况
- ✅ **修改单元** - 实时更新单元信息
- ✅ **删除单元** - 立即释放资源显示

### 2. 跨标签页同步
- 支持同时打开多个"板卡资源"页面
- 所有页面都会同步刷新
- 使用浏览器原生 `BroadcastChannel` API
- 零延迟，实时响应

### 3. 视觉反馈
- 刷新时显示加载动画
- 提示"正在刷新数据..."
- 用户体验友好

## 🔧 技术实现

### 文件结构
```
RuoYi-Vue3/src/
├── utils/
│   └── basebandEvent.js              # 事件通知工具
├── views/system/baseband/
│   ├── unit/index.vue                # 基带单元页面（发送事件）
│   └── resource/index.vue            # 板卡资源页面（监听事件）
```

### 事件通知工具 (basebandEvent.js)

提供了完整的事件通信机制：

```javascript
// 事件类型
BASEBAND_EVENTS = {
  UNIT_CHANGED: 'unit_changed',      // 单元变更
  PARAM_CHANGED: 'param_changed',    // 参数变更
  RESOURCE_REFRESH: 'resource_refresh' // 资源刷新
}

// 发送事件
notifyUnitChanged('add', unitData)

// 监听事件
onBasebandEvent(UNIT_CHANGED, callback)
```

### 基带单元页面集成

在增删改操作完成后发送通知：

```javascript
// 新增成功后
notifyUnitChanged('add', { count: orderedUnitTypes.length })

// 修改成功后
notifyUnitChanged('update', updateData)

// 删除成功后
notifyUnitChanged('delete', { unitIds })
```

### 板卡资源页面集成

监听事件并自动刷新：

```javascript
onMounted(() => {
  // 监听单元变更事件
  unsubscribe = onBasebandEvent(BASEBAND_EVENTS.UNIT_CHANGED, (event) => {
    console.log('收到单元变更通知:', event.data.action)
    // 延迟100ms刷新，确保后端数据已更新
    setTimeout(() => {
      getStats()
    }, 100)
  })
})

onBeforeUnmount(() => {
  // 取消监听
  if (unsubscribe) {
    unsubscribe()
  }
})
```

## 📊 工作流程

```
┌─────────────────┐         ┌──────────────────┐
│  基带单元页面    │         │  板卡资源页面     │
│                 │         │                  │
│  1. 新增单元    │         │  4. 监听到事件   │
│  2. 操作成功    │         │  5. 延迟100ms    │
│  3. 发送事件 ───┼────────>│  6. 刷新数据     │
│                 │         │  7. 更新图表     │
└─────────────────┘         └──────────────────┘
         │                           │
         │    BroadcastChannel       │
         └───────────┬───────────────┘
                     │
         ┌───────────▼───────────┐
         │  其他板卡资源标签页    │
         │  同步刷新              │
         └───────────────────────┘
```

## 🎨 用户体验

### 场景1：新增单元
1. 用户在"基带单元"页面点击"新增"
2. 填写表单，选择板卡资源
3. 点击"确定"，创建成功
4. **板卡资源页面立即刷新**，显示新的资源占用

### 场景2：删除单元
1. 用户在"基带单元"页面删除一个单元
2. 确认删除，操作成功
3. **板卡资源页面立即刷新**，显示资源已释放

### 场景3：多标签页同步
1. 用户同时打开2个"板卡资源"标签页
2. 在"基带单元"页面修改单元
3. **所有板卡资源标签页同时刷新**
4. 数据保持一致

## ⚙️ 配置说明

### 刷新延迟
默认延迟100ms，可以在 `resource/index.vue` 中修改：

```javascript
setTimeout(() => {
  getStats()
}, 100)  // 修改这个值（毫秒）
```

### 定时刷新间隔
默认30秒，可以修改：

```javascript
refreshTimer = setInterval(() => {
  getStats()
}, 30000)  // 修改这个值（毫秒）
```

### 禁用实时刷新
如果不需要实时刷新，注释掉监听代码：

```javascript
// unsubscribe = onBasebandEvent(BASEBAND_EVENTS.UNIT_CHANGED, ...)
```

## 🔍 调试信息

### 查看事件日志
打开浏览器控制台，可以看到：

```
[基带事件] 发送: unit_changed {action: "add", ...}
[板卡资源] 收到单元变更通知: add
```

### 检查 BroadcastChannel 支持
```javascript
console.log('BroadcastChannel 支持:', typeof BroadcastChannel !== 'undefined')
```

## 🌐 浏览器兼容性

### BroadcastChannel API 支持
- ✅ Chrome 54+
- ✅ Edge 79+
- ✅ Firefox 38+
- ✅ Safari 15.4+
- ❌ IE 不支持

### 降级方案
如果浏览器不支持 `BroadcastChannel`，系统会：
- 仍然支持同一页面内的事件通知
- 定时刷新功能正常工作
- 只是跨标签页同步功能不可用

## 📝 扩展用法

### 监听所有事件
```javascript
onBasebandEvent(null, (event) => {
  console.log('收到事件:', event.type, event.data)
})
```

### 手动触发刷新
```javascript
import { requestResourceRefresh } from '@/utils/basebandEvent'

// 在任何地方调用
requestResourceRefresh()
```

### 在其他页面使用
```javascript
import { notifyParamChanged } from '@/utils/basebandEvent'

// 参数配置页面保存后
notifyParamChanged(unitId)
```

## ⚠️ 注意事项

1. **延迟刷新**：事件触发后延迟100ms刷新，确保后端数据已更新
2. **资源清理**：页面卸载时会自动清理监听器和定时器
3. **性能影响**：实时刷新对性能影响很小，可以放心使用
4. **网络延迟**：如果网络较慢，可能需要增加延迟时间

## 🎉 总结

实时刷新功能大幅提升了用户体验：
- ✅ 无需手动刷新页面
- ✅ 数据实时同步
- ✅ 跨标签页一致性
- ✅ 操作反馈及时
- ✅ 实现简单优雅

现在板卡资源监控页面会自动响应基带单元的变化，让资源管理更加高效！🚀
